FROM alpine:latest AS tools_downloader

ARG mongodb_tools_url

# Set default empty values for all platforms
ARG mongodb_tools_version_amd64=""
ARG mongodb_tools_version_arm64=""
ARG mongodb_tools_version_s390x=""
ARG mongodb_tools_version_ppc64le=""

# Create directories
RUN mkdir -p /data/amd64 /data/arm64 /data/s390x /data/ppc64le

# Conditionally download only if the argument is provided
RUN if [ -n "$mongodb_tools_version_amd64" ]; then \
      wget -O /data/amd64/mongodb_tools.tgz "${mongodb_tools_url}/${mongodb_tools_version_amd64}"; \
    fi

RUN if [ -n "$mongodb_tools_version_arm64" ]; then \
      wget -O /data/arm64/mongodb_tools.tgz "${mongodb_tools_url}/${mongodb_tools_version_arm64}"; \
    fi

RUN if [ -n "$mongodb_tools_version_s390x" ]; then \
      wget -O /data/s390x/mongodb_tools.tgz "${mongodb_tools_url}/${mongodb_tools_version_s390x}"; \
    fi

RUN if [ -n "$mongodb_tools_version_ppc64le" ]; then \
      wget -O /data/ppc64le/mongodb_tools.tgz "${mongodb_tools_url}/${mongodb_tools_version_ppc64le}"; \
    fi

FROM alpine:latest AS agent_downloader

ARG mongodb_agent_url

# Set default empty values for all platforms
ARG mongodb_agent_version_amd64=""
ARG mongodb_agent_version_arm64=""
ARG mongodb_agent_version_s390x=""
ARG mongodb_agent_version_ppc64le=""

# Create directories
RUN mkdir -p /data/amd64 /data/arm64 /data/s390x /data/ppc64le

# Conditionally download only if the argument is provided
RUN if [ -n "$mongodb_agent_version_amd64" ]; then \
      wget -O /data/amd64/mongodb_agent.tgz "${mongodb_agent_url}/${mongodb_agent_version_amd64}"; \
    fi

RUN if [ -n "$mongodb_agent_version_arm64" ]; then \
      wget -O /data/arm64/mongodb_agent.tgz "${mongodb_agent_url}/${mongodb_agent_version_arm64}"; \
    fi

RUN if [ -n "$mongodb_agent_version_s390x" ]; then \
      wget -O /data/s390x/mongodb_agent.tgz "${mongodb_agent_url}/${mongodb_agent_version_s390x}"; \
    fi

RUN if [ -n "$mongodb_agent_version_ppc64le" ]; then \
      wget -O /data/ppc64le/mongodb_agent.tgz "${mongodb_agent_url}/${mongodb_agent_version_ppc64le}"; \
    fi

FROM registry.access.redhat.com/ubi9/ubi-minimal

ARG TARGETARCH

# Create directories first
RUN mkdir -p /tools /agent

# Copy the entire platform directory and handle missing files gracefully
COPY --from=tools_downloader "/data/" /tmp/tools_data/
COPY --from=agent_downloader "/data/" /tmp/agent_data/

# Move files to the correct location if they exist
RUN if [ -f "/tmp/tools_data/${TARGETARCH}/mongodb_tools.tgz" ]; then \
      mv "/tmp/tools_data/${TARGETARCH}/mongodb_tools.tgz" /tools/mongodb_tools.tgz; \
    fi && \
    if [ -f "/tmp/agent_data/${TARGETARCH}/mongodb_agent.tgz" ]; then \
      mv "/tmp/agent_data/${TARGETARCH}/mongodb_agent.tgz" /agent/mongodb_agent.tgz; \
    fi && \
    rm -rf /tmp/tools_data /tmp/agent_data

# Replace libcurl-minimal and curl-minimal with the full versions
# https://bugzilla.redhat.com/show_bug.cgi?id=1994521
RUN  microdnf install -y libssh libpsl libbrotli \
    && microdnf download curl libcurl \
    && rpm -Uvh --nodeps --replacefiles "*curl*$( uname -i ).rpm" \
    && microdnf remove -y libcurl-minimal curl-minimal

RUN microdnf install -y --disableplugin=subscription-manager --setopt=install_weak_deps=0 nss_wrapper
# Copy-pasted from https://www.mongodb.com/docs/manual/tutorial/install-mongodb-enterprise-on-red-hat-tarball/
RUN microdnf install -y --disableplugin=subscription-manager \
 cyrus-sasl cyrus-sasl-gssapi cyrus-sasl-plain krb5-libs openldap openssl xz-libs
# Dependencies for the Agent
RUN microdnf install -y --disableplugin=subscription-manager  --setopt=install_weak_deps=0 \
        net-snmp \
        net-snmp-agent-libs
RUN microdnf install -y --disableplugin=subscription-manager \
    hostname tar gzip procps jq \
    && microdnf upgrade -y  \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /agent \
    && mkdir -p /var/lib/mongodb-mms-automation \
      && mkdir -p /var/log/mongodb-mms-automation/ \
      && chmod -R +wr /var/log/mongodb-mms-automation/ \
      # ensure that the agent user can write the logs in OpenShift
      && touch /var/log/mongodb-mms-automation/readiness.log \
      && chmod ugo+rw /var/log/mongodb-mms-automation/readiness.log

# Copy scripts to a safe location that won't be overwritten by volume mount
COPY ./docker/mongodb-kubernetes-init-database/content/LICENSE /data/LICENSE
COPY ./docker/mongodb-agent/agent-launcher-shim.sh /opt/scripts/agent-launcher-shim.sh
COPY ./docker/mongodb-agent/setup-agent-files.sh /opt/scripts/setup-agent-files.sh
COPY ./docker/mongodb-agent/dummy-probe.sh /opt/scripts/dummy-probe.sh
COPY ./docker/mongodb-agent/dummy-readinessprobe.sh /opt/scripts/dummy-readinessprobe.sh

# Extract agent files if they exist
RUN if [ -f "/agent/mongodb_agent.tgz" ]; then \
      tar xfz /agent/mongodb_agent.tgz \
      && mv mongodb-mms-automation-agent-*/mongodb-mms-automation-agent /agent/mongodb-agent \
      && chmod +x /agent/mongodb-agent \
      && rm /agent/mongodb_agent.tgz \
      && rm -r mongodb-mms-automation-agent-*; \
    fi \
    && mkdir -p /var/lib/automation/config \
    && chmod -R +r /var/lib/automation/config

# Extract tools files if they exist
RUN if [ -f "/tools/mongodb_tools.tgz" ]; then \
      tar xfz /tools/mongodb_tools.tgz --directory /var/lib/mongodb-mms-automation/ \
      && rm /tools/mongodb_tools.tgz; \
    fi

ARG version

LABEL name="MongoDB Agent" \
      version="${version}" \
      summary="MongoDB Agent" \
      description="MongoDB Agent" \
      vendor="MongoDB" \
      release="1" \
      maintainer="support@mongodb.com"

USER 2000
CMD ["/agent/mongodb-agent", "-cluster=/var/lib/automation/config/automation-config.json"]
