apiVersion: mongodb.com/v1
kind: MongoDBOpsManager
metadata:
  name: om-upgrade
spec:
  replicas: 1
  # version is configured in the test
  adminCredentials: ops-manager-admin-secret

  # Test mounting only /tmp as RWO PVC with full volumeMount override
  # Attempt to replace the /tmp mount from data volume with a separate PVC
  # while keeping other data subPath mounts intact
  statefulSet:
    spec:
      volumeClaimTemplates:
        - metadata:
            name: tmp-storage
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi
      template:
        spec:
          containers:
            - name: mongodb-ops-manager
              volumeMounts:
                # Use separate PVC for /tmp instead of data subPath
                - name: tmp-storage
                  mountPath: /tmp
                # Keep other mounts using data volume with subPaths
                - name: data
                  mountPath: /mongodb-ops-manager/tmp
                  subPath: tmp-mms
                - name: data
                  mountPath: /mongodb-ops-manager/logs
                  subPath: logs-mms
                - name: data
                  mountPath: /mongodb-ops-manager/etc
                  subPath: etc-mms
                - name: data
                  mountPath: /mongodb-ops-manager/conf
                  subPath: conf-mms
                - name: data
                  mountPath: /mongodb-ops-manager/mongodb-releases
                  subPath: downloads-mms

  backup:
    enabled: true
    s3Stores:
      - name: s3Store1
        s3SecretRef:
          name: my-s3-secret
        pathStyleAccessEnabled: true
        s3BucketEndpoint: s3.us-east-1.amazonaws.com
        s3BucketName: test-bucket

  applicationDatabase:
    # version is configured in the test
    members: 3
    version: "4.4.20-ent"

  # avoid wizard when opening OM UI
  configuration:
    automation.versions.source: mongodb
    mms.testUtil.enabled: "true"
    mms.adminEmailAddr: cloud-manager-support@mongodb.com
    mms.fromEmailAddr: cloud-manager-support@mongodb.com
    mms.ignoreInitialUiSetup: "true"
    mms.mail.hostname: email-smtp.us-east-1.amazonaws.com
    mms.mail.port: "465"
    mms.mail.ssl: "true"
    mms.mail.transport: smtp
    mms.minimumTLSVersion: TLSv1.2
    mms.replyToEmailAddr: cloud-manager-support@mongodb.com
