apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-config
  namespace: ls
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901

    static_resources:
      listeners:
      - name: mongod_listener
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 27029
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: ingress_http
              codec_type: AUTO
              route_config:
                name: local_route
                virtual_hosts:
                - name: mongot_backend
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                      grpc: {}
                    route:
                      cluster: mongot_cluster
                      timeout: 300s
              http_filters:
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
              http2_protocol_options:
                initial_connection_window_size: 1048576     # 1MB
                initial_stream_window_size: 1048576         # 1MB
              stream_idle_timeout: 300s
              request_timeout: 300s
          # Downstream TLS context (accepting connections from mongod)
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              common_tls_context:
                key_log:
                  path: /tmp/downstream_keys.log
                # Envoy's server certificate (presented to mongod)
                # Using combined PEM file with both cert and key
                tls_certificates:
                - certificate_chain:
                    filename: /etc/envoy/tls/server/cert.pem
                  private_key:
                    filename: /etc/envoy/tls/server/cert.pem
                # CA to validate mongod's client certificate
                validation_context:
                  trusted_ca:
                    filename: /etc/envoy/tls/ca/ca-pem
                  # Optional: verify Subject Alternative Names
                  match_typed_subject_alt_names:
                  - san_type: DNS
                    matcher:
                      suffix: ".ls.svc.cluster.local"
                tls_params:
                  tls_minimum_protocol_version: TLSv1_2
                  tls_maximum_protocol_version: TLSv1_2
                  cipher_suites:
                  - "ECDHE-ECDSA-AES128-GCM-SHA256"
                  - "ECDHE-RSA-AES128-GCM-SHA256"
                  - "ECDHE-ECDSA-AES256-GCM-SHA384"
                  - "ECDHE-RSA-AES256-GCM-SHA384"
                  ecdh_curves:
                  - "X25519"
                  - "P-256"
                alpn_protocols:
                - "h2"
              # Require client certificate (mTLS from mongod)
              require_client_certificate: true

      clusters:
      - name: mongot_cluster
        type: STRICT_DNS
        lb_policy: ROUND_ROBIN
        http2_protocol_options:
          initial_connection_window_size: 1048576
          initial_stream_window_size: 1048576
        load_assignment:
          cluster_name: mongot_cluster
          endpoints:
          - lb_endpoints:
            # Headless service DNS will resolve to all mongot pods
            - endpoint:
                address:
                  socket_address:
                    address: mdb-ent-tls-search-svc.ls.svc.cluster.local
                    port_value: 27028
        # Connection pool and circuit breaker settings
        circuit_breakers:
          thresholds:
          - priority: DEFAULT
            max_connections: 1024
            max_pending_requests: 1024
            max_requests: 1024
            max_retries: 3
        # Upstream TLS context (connecting to mongot)
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              # Envoy's client certificate (presented to mongot)
              # Using combined PEM file with both cert and key
              key_log:
                path: /tmp/upstream_keys.log
              tls_certificates:
              - certificate_chain:
                  filename: /etc/envoy/tls/client/cert.pem
                private_key:
                  filename: /etc/envoy/tls/client/cert.pem
              # CA to validate mongot's server certificate
              validation_context:
                trusted_ca:
                  filename: /etc/envoy/tls/ca/ca-pem
                match_typed_subject_alt_names:
                - san_type: DNS
                  matcher:
                    suffix: ".ls.svc.cluster.local"
              tls_params:
                tls_minimum_protocol_version: TLSv1_2
                tls_maximum_protocol_version: TLSv1_2
                cipher_suites:
                - "ECDHE-ECDSA-AES128-GCM-SHA256"
                - "ECDHE-RSA-AES128-GCM-SHA256"
                - "ECDHE-ECDSA-AES256-GCM-SHA384"
                - "ECDHE-RSA-AES256-GCM-SHA384"
                ecdh_curves:
                - "X25519"
                - "P-256"
              alpn_protocols:
              - "h2"
            # SNI for mongot server verification
            sni: mdb-ent-tls-search-svc.ls.svc.cluster.local
        # Health checks disabled because mongot doesn't implement gRPC Health Checking Protocol
        # mongot has HTTP health endpoint on port 8080, but Envoy can't easily health check
        # a different port than the cluster endpoint
        # The cluster will be considered healthy by default
        # health_checks:
        # - timeout: 1s
        #   interval: 5s
        #   unhealthy_threshold: 3
        #   healthy_threshold: 2
        #   http_health_check:
        #     path: /health
        # Connection keepalive
        upstream_connection_options:
          tcp_keepalive:
            keepalive_time: 10
            keepalive_interval: 3
            keepalive_probes: 3
        # Retry policy for transient failures
        common_http_protocol_options:
          idle_timeout: 300s

    # Layered runtime for dynamic configuration
    layered_runtime:
      layers:
      - name: static_layer
        static_layer:
          overload:
            global_downstream_max_connections: 50000
