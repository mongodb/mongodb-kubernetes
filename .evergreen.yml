# For .evergreen.yml configuration and usage reference, see EVERGREEN.md file

# 2h timeout for all the tasks
exec_timeout_secs: 7200

include:
  - filename: .evergreen-functions.yml
  - filename: .evergreen-tasks.yml
  - filename: .evergreen-mco.yml
  - filename: .evergreen-snippets.yml
  - filename: .evergreen-release.yml

variables:
  - &ops_manager_60_latest 6.0.27 # The order/index is important, since these are anchors. Please do not change

  - &ops_manager_70_latest 7.0.21 # The order/index is important, since these are anchors. Please do not change

  - &ops_manager_80_latest 8.0.18 # The order/index is important, since these are anchors. Please do not change

  # The dependency unification between static and non-static is intentional here.
  # Even though some images are exclusive, in EVG they all are built once and in parallel.
  # It is not worth the effort of splitting them out.
  # Once Static Containers are default, this piece can be cleaned up.
  - &base_om6_dependency
    depends_on:
      - name: build_om_images
        variant: build_om60_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: publish_helm_chart
        variant: init_test_run

  - &base_no_om_image_dependency
    depends_on:
      - name: build_om_images
        variant: build_om70_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: publish_helm_chart
        variant: init_test_run

  - &community_dependency
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_readiness_probe_image
        variant: init_test_run
      - name: build_version_upgrade_hook_image
        variant: init_test_run
      - name: build_mco_test_image
        variant: init_test_run
      - name: publish_helm_chart
        variant: init_test_run

  - &setup_group
    setup_group_can_fail_task: true
    setup_group:
      - func: clone
      - func: download_kube_tools
      - func: switch_context
      - func: setup_building_host

  - &setup_group_ibm
    setup_group_can_fail_task: true
    setup_group:
      - func: clone
      - func: switch_context
      - func: setup_building_host_minikube

  - &setup_group_multi_cluster
    setup_group_can_fail_task: true
    setup_group:
      - func: clone
      - func: download_kube_tools
      - func: switch_context
      - func: setup_building_host

  - &setup_and_teardown_task_cloudqa
    setup_task_can_fail_task: true
    setup_task:
      - func: cleanup_exec_environment
      - func: configure_docker_auth
      - func: switch_context
      - func: setup_kubernetes_environment
      - func: setup_cloud_qa
    teardown_task_can_fail_task: true
    teardown_task:
      - func: teardown_cloud_qa
      - func: upload_e2e_logs
      - func: teardown_kubernetes_environment

  - &setup_and_teardown_task
    setup_task_can_fail_task: true
    setup_task:
      - func: cleanup_exec_environment
      - func: configure_docker_auth
      - func: setup_kubernetes_environment
      - func: switch_context
    teardown_task_can_fail_task: true
    teardown_task:
      - func: upload_e2e_logs
      - func: teardown_kubernetes_environment

  - &teardown_group
    teardown_group:
      - func: prune_docker_resources
      - func: run_retry_script

  - &base_om7_dependency
    depends_on:
      - name: build_om_images
        variant: build_om70_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: publish_helm_chart
        variant: init_test_run
      # Wait for OM images to be published to quay.io on commit builds (staging).
      # On patch builds, this dependency is skipped (task doesn't exist).
      - name: release_om_and_agents
        variant: release_om_and_agents
        patch_optional: true

  - &base_om7_dependency_with_race
    depends_on:
      - name: build_om_images
        variant: build_om70_images
      - name: build_operator_race_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: publish_helm_chart
        variant: init_test_run

  # Any change to base_om8_dependency should be reflected to its copy in .evergreen-snippets.yml
  - &base_om8_dependency
    depends_on:
      - name: build_om_images
        variant: build_om80_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: publish_helm_chart
        variant: init_test_run
      # Wait for OM images to be published to quay.io on commit builds (staging).
      # On patch builds, this dependency is skipped (task doesn't exist).
      - name: release_om_and_agents
        variant: release_om_and_agents
        patch_optional: true

parameters:
  - key: evergreen_retry
    value: "true"
    description: set this to false to suppress retries on failure

  - key: OVERRIDE_VERSION_ID
    value: ""
    description: "Patch id to reuse images from other Evergreen build"

  - key: code_snippets_teardown
    value: "true"
    description: set this to false if you would like to keep the clusters created during code snippets tests

  - key: code_snippets_reset
    value: "false"
    description: set this to true if you would like to delete the resources created in the code snippet tests, but keep the clusters

  - key: MDB_BASH_DEBUG
    value: "0"
    description: set this to 1 if you want shell scripts to enable set -x

# Triggered manually or by PCT.
patch_aliases:
  - alias: "periodic_teardowns"
    variant_tags: [ "periodic_teardown" ]
    task: ".*"
  - alias: "release_agent"
    variant_tags: [ "release_agent" ]
    task: ".*"
  - alias: "release_all_agents_manually"
    variant_tags: [ "release_all_agents_manually" ]
    task: ".*"
  - alias: "release_current_agents_manually"
    variant_tags: [ "release_current_agents_manually" ]
    task: ".*"
  - alias: "smoke_test_release"
    variant_tags: [ "e2e_smoke_release_test_suite" ]
    task_tags: [ "patch-run" ]
  - alias: "smoke_test"
    variant_tags: [ "e2e_smoke_test_suite" ]
    task_tags: [ "patch-run" ]
  - alias: "patch-run-cloudqa"
    variant_tags: [ "cloudqa_non_static" ]
    task: ".*"
  - alias: "release"
    variant_tags: [ "release" ]
    task: ".*"
  - alias: "staging"
    variant_tags: [ "staging" ]
    task: ".*"
  - alias: "pr_patch"
    variant_tags: [ "pr_patch" ]
    task: ".*"

# Triggered whenever the GitHub PR is created
github_pr_aliases:
  - variant_tags: [ "pr_patch" ]
    task: ".*"

# Allows to see evergreen checks in GitHub commits
# https://github.com/mongodb/mongodb-kubernetes/commits/master/
github_checks_aliases:
  - variant: ".*"
    task: ".*"

# Triggered on git tag
git_tag_aliases:
  - git_tag: "^(\\d+\\.)?(\\d+\\.)?(\\d+)$"
    variant_tags: [ "release" ]
    task: ".*"

tasks:
  - name: unit_tests_golang
    tags: [ "unit_tests" ]
    commands:
      - func: "test_golang_unit"

  - name: unit_tests_python
    tags: [ "unit_tests" ]
    commands:
      - func: "test_python_unit"

  - name: unit_tests_helm
    tags: [ "unit_tests" ]
    commands:
      - func: "test_helm_unit"

  - name: sbom_tests
    tags: [ "unit_tests" ]
    # The SBOM tests run only on commit builds. Running this on patches might cause false-positive failures
    # because certain images might not be there yet. Such situation happens for OM image upgrades for example.
    # See https://docs.devprod.prod.corp.mongodb.com/evergreen/Project-Configuration/Project-Configuration-Files#limiting-when-a-task-or-variant-will-run
    patchable: false
    commands:
      - func: "test_sboms"

  - name: lint_repo
    tags: [ "unit_tests" ]
    commands:
      - func: lint_repo

  # Runs on every merge - detects release.json changes and releases appropriate images
  - name: release_om_and_agents
    allowed_requesters: [ "patch" , "commit"]
    commands:
      - func: clone
      - func: python_venv
      - func: setup_building_host
      - func: quay_login
      - func: setup_docker_sbom
      - command: subprocess.exec
        params:
          working_dir: src/github.com/mongodb/mongodb-kubernetes
          binary: scripts/dev/run_python.sh
          args:
            - scripts/release/release_om_and_agents.py

  - name: migrate_all_agents
    # this enables us to run this variant manually to build all the agents for the new agent registry
    allowed_requesters: [ "patch" ]
    commands:
      - func: clone
      - func: setup_building_host
      - func: quay_login
      - func: pipeline
        vars:
          image_name: agent
          build_scenario: release
          flags: "--parallel --all-agents -r quay.io/mongodb/mongodb-agent --skip-if-exists=false"

  - name: run_precommit_and_push
    tags: [ "patch-run" ]
    commands:
      - func: clone
      - func: python_venv
      - func: download_kube_tools
      - func: setup_shellcheck
      - command: github.generate_token
        params:
          expansion_name: GH_TOKEN
      - func: setup_chart_testing_cli
      - command: subprocess.exec
        type: setup
        params:
          include_expansions_in_env:
            - GH_TOKEN
          working_dir: src/github.com/mongodb/mongodb-kubernetes
          binary: scripts/evergreen/precommit_bump.sh

  - name: run_conditionally_precommit_and_push
    tags: [ "patch-run" ]
    commands:
      - func: clone
      - func: run_task_conditionally
        vars:
          condition_script: scripts/evergreen/should_run_precommit_and_push.sh
          variant: run_pre_commit
          task: run_precommit_and_push

  - name: rebuild_all_agents
    # this enables us to run this manually (patch) and rebuild all agent versions to verify
    # Dockerfile, script changes etc.
    allowed_requesters: [ "patch" ]
    commands:
      - func: clone
      - func: setup_building_host
      - func: quay_login
      - func: pipeline
        vars:
          agent_version: all
          image_name: agent
          flags: "--parallel --skip-if-exists=false"

  - name: rebuild_currently_used_agents
    # this enables us to run this manually (patch) and rebuild current agent versions to verify
    # Dockerfile, script changes etc.
    allowed_requesters: [ "patch" ]
    commands:
      - func: clone
      - func: setup_building_host
      - func: quay_login
      - func: pipeline
        vars:
          agent_version: current
          image_name: agent
          flags: "--parallel --skip-if-exists=false"

  - name: build_kubectl_mongodb_plugin
    commands:
      - func: clone
      - func: setup_building_host
      - func: build_multi_cluster_binary

  - name: build_test_image
    commands:
      - func: clone
      - func: setup_building_host
      - func: download_multi_cluster_binary
        vars:
          platform: linux/amd64
      - func: pipeline
        vars:
          image_name: meko-tests

  - name: build_test_image_arm
    commands:
      - func: clone
      - func: setup_building_host
      - func: download_multi_cluster_binary
        vars:
          platform: linux/arm64
      - func: pipeline
        vars:
          image_name: meko-tests-arm64

  - name: build_test_image_ibm_z
    commands:
      - func: clone
      - func: setup_building_host_minikube
        vars:
          skip_minikube_setup: true
      - func: download_multi_cluster_binary
        vars:
          platform: linux/s390x
      - func: pipeline
        vars:
          image_name: meko-tests-ibm-z

  - name: build_test_image_ibm_power
    commands:
      - func: clone
      - func: setup_building_host_minikube
        vars:
          skip_minikube_setup: true
      - func: download_multi_cluster_binary
        vars:
          platform: linux/ppc64le
      - func: pipeline
        vars:
          image_name: meko-tests-ibm-power

  - name: build_mco_test_image
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: mco-tests

  - name: build_operator_ubi
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: operator

  - name: build_operator_race_ubi
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: operator-race

  - name: build_init_om_images_ubi
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: init-ops-manager

  - name: build_init_appdb_images_ubi
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: init-appdb

  - name: build_agent_images_ubi
    commands:
      - func: clone
      - func: setup_building_host
      - func: quay_login
      - func: pipeline
        vars:
          image_name: agent
          agent_version: all
          flags: "--parallel"

  - name: build_init_database_image_ubi
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: init-database

  - name: build_database_image_ubi
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: database

  - name: build_readiness_probe_image
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: readiness-probe

  - name: build_version_upgrade_hook_image
    commands:
      - func: clone
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: upgrade-hook

  - name: publish_helm_chart
    commands:
      - func: clone
      - func: python_venv
      - func: setup_kubectl
      - func: setup_aws
      - func: prepare_aws
      - func: helm_registry_login
      - func: publish_helm_chart

  - name: prepare_aws
    priority: 59
    commands:
      - func: clone
      - func: setup_jq
      - func: setup_aws
      - func: prepare_aws

  - name: run_retry_script
    tags: [ "patch-run" ]
    commands:
      - func: run_retry_script

  - name: generate_perf_tasks_one_thread
    commands:
      - func: clone
      - func: switch_context
      - func: generate_perf_tests_tasks
        vars:
          variant: e2e_operator_perf_one_thread
          size: small

  - name: generate_perf_tasks_10_thread
    commands:
      - func: clone
      - func: switch_context
      - func: generate_perf_tests_tasks
        vars:
          variant: e2e_operator_perf
          size: small

  - name: generate_perf_tasks_30_thread
    commands:
      - func: clone
      - func: switch_context
      - func: generate_perf_tests_tasks
        vars:
          variant: e2e_operator_perf_thirty
          size: small

  - name: build_om_images
    commands:
      - func: clone
      - func: switch_context
      - func: setup_building_host
      - func: pipeline
        vars:
          image_name: ops-manager

  - name: publish_ops_manager
    commands:
      - func: clone
      - func: switch_context
      - func: setup_building_host
      - func: quay_login
      - func: setup_docker_sbom
      - func: pipeline
        vars:
          image_name: ops-manager
          build_scenario: release

  - name: prepare_and_upload_openshift_bundles_for_e2e
    commands:
      - func: clone
      - func: setup_building_host
      - func: download_kube_tools
      - func: setup_prepare_openshift_bundles
      - func: prepare_openshift_bundles_for_e2e

  - name: backup_csv_images_dry_run
    commands:
      - func: clone
      - func: quay_login
      - command: subprocess.exec
        params:
          working_dir: src/github.com/mongodb/mongodb-kubernetes
          binary: python3
          args:
            - scripts/dev/release/backup_csv_images.py
            - scripts/dev/release/1.2.0.clusterserviceversion.yaml
            - --dry-run
            - --verbose
  - name: backup_csv_images_limit_3
    commands:
      - func: clone
      - func: quay_login
      - command: subprocess.exec
        params:
          working_dir: src/github.com/mongodb/mongodb-kubernetes
          binary: python3
          args:
            - scripts/dev/release/backup_csv_images.py
            - scripts/dev/release/1.2.0.clusterserviceversion.yaml
            - --limit
            - "3"
            - --verbose
  - name: backup_csv_images_all
    commands:
      - func: clone
      - func: quay_login
      - command: subprocess.exec
        params:
          working_dir: src/github.com/mongodb/mongodb-kubernetes
          binary: python3
          args:
            - scripts/dev/release/backup_csv_images.py
            - scripts/dev/release/1.2.0.clusterserviceversion.yaml
            - --verbose

task_groups:
  - name: unit_task_group
    max_hosts: -1
    setup_group_can_fail_task: true
    setup_group:
      - func: clone
      - func: python_venv
      - func: download_kube_tools
      - func: setup_shellcheck
    tasks:
      - lint_repo
      - unit_tests_golang
      - unit_tests_python
      - unit_tests_helm
      - sbom_tests

  # Task group for deploying mongodbcommunity resources and testing the (former) MCO
  - name: e2e_mdb_community_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_community_replicaset_scale
      - e2e_search_community_basic
      - e2e_search_community_tls
      - e2e_search_external_basic
      - e2e_search_external_tls

  # This is the task group that contains all the tests run in the e2e_mdb_kind_ubi_cloudqa build variant
  - name: e2e_mdb_kind_cloudqa_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      # e2e_kube_only_task_group
      - e2e_crd_validation
      - e2e_replica_set_config_map
      - e2e_replica_set_exposed_externally
      - e2e_replica_set_pv
      - e2e_replica_set_pv_multiple
      - e2e_replica_set_schema_validation
      - e2e_replica_set_statefulset_status
      - e2e_sharded_cluster_pv
      - e2e_sharded_cluster_recovery
      - e2e_sharded_cluster_schema_validation
      - e2e_sharded_cluster_statefulset_status
      - e2e_standalone_config_map
      - e2e_standalone_recovery
      - e2e_standalone_schema_validation
      - e2e_users_schema_validation
      - e2e_replica_set_tls_default
      - e2e_replica_set_tls_override
      - e2e_replica_set_ignore_unknown_users
      # e2e_core_task_group
      - e2e_all_mongodb_resources_parallel
      - e2e_multiple_cluster_failures
      - e2e_replica_set_custom_podspec
      - e2e_replica_set_custom_sa
      - e2e_replica_set_report_pending_pods
      - e2e_replica_set_recovery
      - e2e_replica_set_upgrade_downgrade
      - e2e_replica_set_agent_flags_and_readinessProbe
      - e2e_sharded_cluster
      - e2e_sharded_cluster_secret
      - e2e_sharded_cluster_upgrade_downgrade
      - e2e_sharded_cluster_custom_podspec
      - e2e_sharded_cluster_agent_flags
      - e2e_standalone_upgrade_downgrade
      - e2e_standalone_custom_podspec
      - e2e_standalone_agent_flags
      - e2e_replica_set_process_hostnames
      - e2e_replica_set_member_options
      # e2e_tls_task_group
      - e2e_replica_set_tls_allow
      - e2e_replica_set_tls_prefer
      - e2e_replica_set_tls_require_upgrade
      - e2e_tls_rs_additional_certs
      - e2e_tls_sc_additional_certs
      - e2e_tls_rs_intermediate_ca
      - e2e_tls_sharded_cluster_certs_prefix
      - e2e_sharded_cluster_migration
      - e2e_standalone_no_tls_no_status_is_set
      - e2e_feature_controls_authentication
      - e2e_replica_set
      - e2e_replica_set_liveness_probe
      - e2e_replica_set_mongod_options
      - e2e_replica_set_readiness_probe
      - e2e_replica_set_update_delete_parallel
      - e2e_sharded_cluster_scale_shards
      - e2e_sharded_cluster_shard_overrides
      - e2e_sharded_cluster_mongod_options_and_log_rotation
      - e2e_tls_rs_external_access
      - e2e_replica_set_tls_require
      - e2e_replica_set_tls_certs_secret_prefix
      - e2e_disable_tls_and_scale
      - e2e_replica_set_tls_require_and_disable
      # e2e_x509_task_group
      - e2e_configure_tls_and_x509_simultaneously_st
      - e2e_configure_tls_and_x509_simultaneously_rs
      - e2e_configure_tls_and_x509_simultaneously_sc
      - e2e_tls_x509_rs
      - e2e_tls_x509_sc
      - e2e_tls_x509_configure_all_options_rs
      - e2e_tls_x509_configure_all_options_sc
      - e2e_tls_x509_user_connectivity
      - e2e_tls_x509_users_addition_removal
      - e2e_replica_set_tls_process_hostnames
      # e2e_ldap_task_group
      - e2e_replica_set_ldap
      - e2e_sharded_cluster_ldap
      - e2e_replica_set_ldap_tls
      - e2e_replica_set_ldap_user_to_dn_mapping
      # e2e_replica_set_ldap_agent_auth
      - e2e_replica_set_ldap_agent_client_certs
      - e2e_replica_set_ldap_custom_roles
      - e2e_replica_set_update_roles_no_privileges
      - e2e_replica_set_ldap_group_dn
      - e2e_replica_set_ldap_group_dn_with_x509_agent
      # e2e_scram_sha_task_group_with_manually_generated_certs
      - e2e_replica_set_scram_sha_256_user_connectivity
      - e2e_replica_set_scram_sha_256_user_first
      - e2e_replica_set_scram_sha_1_user_connectivity
      - e2e_replica_set_scram_sha_1_upgrade
      - e2e_replica_set_scram_x509_ic_manual_certs
      - e2e_sharded_cluster_scram_sha_1_upgrade
      - e2e_sharded_cluster_scram_sha_256_user_connectivity
      - e2e_sharded_cluster_scram_sha_1_user_connectivity
      - e2e_sharded_cluster_scram_x509_ic_manual_certs
      - e2e_sharded_cluster_external_access
      - e2e_replica_set_scram_sha_256_switch_project
      - e2e_sharded_cluster_scram_sha_256_switch_project
      - e2e_replica_set_scram_sha_1_switch_project
      - e2e_sharded_cluster_scram_sha_1_switch_project
      # TODO CLOUDP-349093 - Disabled these tests as they don't use the password secret, and project migrations aren't fully supported yet.
      # e2e_sharded_cluster_x509_switch_project
      # e2e_replica_set_x509_switch_project
      # e2e_replica_set_ldap_switch_project
      # e2e_sharded_cluster_ldap_switch_project
      # e2e_auth_transitions_task_group
      - e2e_replica_set_scram_sha_and_x509
      - e2e_replica_set_x509_to_scram_transition
      - e2e_sharded_cluster_scram_sha_and_x509
      - e2e_sharded_cluster_x509_to_scram_transition
      - e2e_sharded_cluster_internal_cluster_transition
      # e2e_webhook_validation_task_group
      - e2e_mongodb_validation_webhook
      - e2e_mongodb_roles_validation_webhook
      - e2e_vault_setup
      - e2e_vault_setup_tls
      # this test will either migrate from static to non-static or the other way around
      - e2e_replica_set_migration
      - e2e_replica_set_pv_resize
      - e2e_sharded_cluster_pv_resize
      - e2e_community_and_meko_replicaset_scale
      # OIDC test group
      - e2e_replica_set_oidc_m2m_group
      - e2e_replica_set_oidc_m2m_user
      - e2e_replica_set_oidc_workforce
      - e2e_sharded_cluster_oidc_m2m_group
      - e2e_sharded_cluster_oidc_m2m_user
      # MongoDBSearch test group
      - e2e_search_enterprise_basic
      - e2e_search_enterprise_tls
      - e2e_search_enterprise_x509_cluster_auth
    <<: *teardown_group

  # this task group contains just a one task, which is smoke testing whether the operator
  # works correctly when we run it without installing webhook cluster roles
  - name: e2e_mdb_kind_no_webhook_roles_cloudqa_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_replica_set_agent_flags_and_readinessProbe
    <<: *teardown_group

  # This task group mostly duplicates tests running in e2e_mdb_kind_ubi_cloudqa
  # This is mostly a smoke test, so we execute only a few essential ones.
  - name: e2e_mdb_openshift_ubi_cloudqa_task_group
    # OM tests are also run on the same Openshift cluster, so we use 1 max host to not
    # allow the helm installations to interfere with each other during the setup of the tests.
    max_hosts: 1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_crd_validation
      - e2e_replica_set_scram_sha_256_user_connectivity
      - e2e_sharded_cluster_scram_sha_256_user_connectivity
      - e2e_replica_set_pv
      - e2e_sharded_cluster_pv

  - name: e2e_custom_domain_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_replica_set

  # e2e_operator_task_group includes the tests for the specific Operator configuration/behavior. They may deal with
  # cluster-wide resources so should be run in isolated K8s clusters only (Kind or Minikube).
  - name: e2e_operator_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_operator_upgrade_replica_set
      - e2e_sharded_cluster_operator_upgrade_v1_27_to_mck
      - e2e_operator_upgrade_ops_manager
      - e2e_operator_proxy
      - e2e_operator_partial_crd
      - e2e_operator_clusterwide
      - e2e_operator_multi_namespaces
      - e2e_appdb_tls_operator_upgrade_v1_32_to_mck
      - e2e_meko_mck_upgrade
    <<: *teardown_group

  # e2e_operator_race_with_telemetry_task_group includes the tests for testing the operator with race detector enabled
  # additionally, it sends telemetry to cloud-dev; more here: https://wiki.corp.mongodb.com/display/MMS/Telemetry
  - name: e2e_operator_race_with_telemetry_task_group
    max_hosts: -1
    <<: *setup_group_multi_cluster
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_reconcile_race_with_telemetry
    <<: *teardown_group

  # e2e_operator_task_group includes the tests for the specific Operator configuration/behavior. They may deal with
  # cluster-wide resources so should be run in isolated K8s clusters only (Kind or Minikube).
  - name: e2e_static_operator_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_operator_upgrade_replica_set
      - e2e_sharded_cluster_operator_upgrade_v1_27_to_mck
      - e2e_operator_upgrade_ops_manager
      - e2e_operator_proxy
      - e2e_operator_partial_crd
      - e2e_operator_clusterwide
      - e2e_operator_multi_namespaces
      - e2e_appdb_tls_operator_upgrade_v1_32_to_mck
      - e2e_meko_mck_upgrade
    <<: *teardown_group

  - name: e2e_multi_cluster_kind_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_multi_cluster_replica_set
      - e2e_multi_cluster_replica_set_migration
      - e2e_multi_cluster_replica_set_member_options
      - e2e_multi_cluster_recover
      - e2e_multi_cluster_recover_clusterwide
      - e2e_multi_cluster_specific_namespaces
      - e2e_multi_cluster_scram
      - e2e_multi_cluster_tls_with_x509
      - e2e_multi_cluster_tls_no_mesh
      - e2e_multi_cluster_enable_tls
      # e2e_multi_cluster_with_ldap
      # e2e_multi_cluster_with_ldap_custom_roles
      - e2e_multi_cluster_mtls_test
      - e2e_multi_cluster_replica_set_deletion
      - e2e_multi_cluster_replica_set_scale_up
      - e2e_multi_cluster_scale_up_cluster
      - e2e_multi_cluster_scale_up_cluster_new_cluster
      - e2e_multi_cluster_replica_set_scale_down
      - e2e_multi_cluster_scale_down_cluster
      - e2e_multi_sts_override
      - e2e_multi_cluster_tls_with_scram
      - e2e_multi_cluster_upgrade_downgrade
      - e2e_multi_cluster_backup_restore
      - e2e_multi_cluster_backup_restore_no_mesh
      - e2e_multi_cluster_disaster_recovery
      - e2e_multi_cluster_multi_disaster_recovery
      - e2e_multi_cluster_recover_network_partition
      - e2e_multi_cluster_validation
      - e2e_multi_cluster_agent_flags
      - e2e_multi_cluster_replica_set_ignore_unknown_users
      - e2e_multi_cluster_pvc_resize
      - e2e_multi_cluster_sharded_geo_sharding
      - e2e_multi_cluster_sharded_scaling
      - e2e_multi_cluster_sharded_scaling_all_shard_overrides
      - e2e_multi_cluster_sharded_simplest
      - e2e_multi_cluster_sharded_snippets
      - e2e_multi_cluster_sharded_simplest_no_mesh
      - e2e_multi_cluster_sharded_external_access_no_ext_domain
      - e2e_multi_cluster_sharded_tls_no_mesh
      - e2e_multi_cluster_sharded_tls
      - e2e_multi_cluster_sharded_disaster_recovery
      - e2e_sharded_cluster
      - e2e_sharded_cluster_agent_flags
      - e2e_sharded_cluster_custom_podspec
      - e2e_sharded_cluster_mongod_options_and_log_rotation
      - e2e_sharded_cluster_migration
      - e2e_sharded_cluster_pv
      - e2e_sharded_cluster_pv_resize
      - e2e_sharded_cluster_recovery
      - e2e_sharded_cluster_scale_shards
      - e2e_sharded_cluster_shard_overrides
      - e2e_sharded_cluster_secret
      - e2e_sharded_cluster_statefulset_status
      - e2e_sharded_cluster_upgrade_downgrade
      - e2e_configure_tls_and_x509_simultaneously_sc
      - e2e_sharded_cluster_tls_require_custom_ca
      - e2e_tls_sharded_cluster_certs_prefix
      - e2e_tls_sc_additional_certs
      - e2e_tls_x509_configure_all_options_sc
      - e2e_tls_x509_sc
      - e2e_meko_mck_upgrade
      - e2e_mongodb_custom_roles
      - e2e_sharded_cluster_oidc_m2m_group
      - e2e_sharded_cluster_oidc_m2m_user
      - e2e_multi_cluster_oidc_m2m_group
      - e2e_multi_cluster_oidc_m2m_user

    <<: *teardown_group

  - name: e2e_multi_cluster_2_clusters_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_multi_cluster_2_clusters_replica_set
      - e2e_multi_cluster_2_clusters_clusterwide
    <<: *teardown_group

  - name: e2e_multi_cluster_om_appdb_task_group
    max_hosts: -1
    <<: *setup_group_multi_cluster
    <<: *setup_and_teardown_task
    tasks:
      # Dedicated AppDB Multi-Cluster tests
      - e2e_multi_cluster_appdb_validation
      - e2e_multi_cluster_om_validation
      - e2e_multi_cluster_appdb
      - e2e_multi_cluster_appdb_cleanup
      - e2e_multi_cluster_appdb_s3_based_backup_restore
      - e2e_multi_cluster_appdb_disaster_recovery
      - e2e_multi_cluster_appdb_disaster_recovery_force_reconfigure
      - e2e_multi_cluster_om_networking_clusterwide
      - e2e_multi_cluster_om_appdb_no_mesh
      # Reused OM tests with AppDB Multi-Cluster topology
      - e2e_appdb_tls_operator_upgrade_v1_32_to_mck
      - e2e_om_appdb_flags_and_config
      - e2e_om_appdb_upgrade
      - e2e_om_appdb_monitoring_tls
      - e2e_om_ops_manager_backup
      - e2e_om_ops_manager_backup_light
      - e2e_om_ops_manager_backup_liveness_probe
      - e2e_om_ops_manager_pod_spec
      - e2e_om_ops_manager_secure_config
      - e2e_om_appdb_validation
      - e2e_om_appdb_scram
      - e2e_om_external_connectivity
      - e2e_om_jvm_params
      - e2e_om_migration
      - e2e_om_localmode
      - e2e_om_ops_manager_enable_local_mode_running_om
      - e2e_om_localmode_multiple_pv
      - e2e_om_weak_password
      - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
      - e2e_om_ops_manager_backup_tls
      - e2e_om_ops_manager_backup_s3_tls
      - e2e_om_ops_manager_backup_tls_custom_ca
      - e2e_om_ops_manager_backup_sharded_cluster
      - e2e_om_ops_manager_backup_kmip
      - e2e_om_ops_manager_https_enabled
      - e2e_om_ops_manager_https_enabled_hybrid
      - e2e_om_ops_manager_https_enabled_internet_mode
      - e2e_om_ops_manager_https_enabled_prefix
      - e2e_om_ops_manager_scale
      - e2e_om_ops_manager_upgrade
      - e2e_om_update_before_reconciliation
      - e2e_om_feature_controls
      - e2e_multi_cluster_appdb_upgrade_downgrade_v1_27_to_mck
      - e2e_multi_cluster_sharded_disaster_recovery
    # disabled tests:
    #    - e2e_om_multiple # multi-cluster failures in EVG
    #    - e2e_om_appdb_scale_up_down # test not "reused" for multi-cluster appdb
    <<: *teardown_group

  - name: e2e_static_multi_cluster_om_appdb_task_group
    max_hosts: -1
    <<: *setup_group_multi_cluster
    <<: *setup_and_teardown_task
    tasks:
      # Dedicated AppDB Multi-Cluster tests
      - e2e_multi_cluster_appdb_validation
      - e2e_multi_cluster_om_validation
      - e2e_multi_cluster_appdb
      - e2e_multi_cluster_appdb_cleanup
      - e2e_multi_cluster_appdb_s3_based_backup_restore
      - e2e_multi_cluster_appdb_disaster_recovery
      - e2e_multi_cluster_appdb_disaster_recovery_force_reconfigure
      - e2e_multi_cluster_om_networking_clusterwide
      - e2e_multi_cluster_om_appdb_no_mesh
      # Reused OM tests with AppDB Multi-Cluster topology
      - e2e_om_appdb_flags_and_config
      - e2e_om_appdb_upgrade
      - e2e_om_appdb_monitoring_tls
      - e2e_om_ops_manager_backup
      - e2e_om_ops_manager_backup_light
      - e2e_om_ops_manager_backup_liveness_probe
      - e2e_om_ops_manager_pod_spec
      - e2e_om_ops_manager_secure_config
      - e2e_om_appdb_validation
      - e2e_om_appdb_scram
      - e2e_om_external_connectivity
      - e2e_om_jvm_params
      - e2e_om_migration
      #  Deactivated tests
      #    - e2e_om_localmode
      #    - e2e_om_localmode_multiple_pv
      #    - e2e_om_ops_manager_https_enabled
      #    - e2e_om_ops_manager_https_enabled_hybrid
      #    - e2e_om_ops_manager_https_enabled_internet_mode
      - e2e_om_ops_manager_https_enabled_prefix
      - e2e_om_ops_manager_enable_local_mode_running_om
      - e2e_om_weak_password
      - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
      - e2e_om_ops_manager_backup_tls
      - e2e_om_ops_manager_backup_s3_tls
      - e2e_om_ops_manager_backup_tls_custom_ca
      - e2e_om_ops_manager_backup_sharded_cluster
      - e2e_om_ops_manager_backup_kmip
      - e2e_om_ops_manager_scale
      - e2e_om_ops_manager_upgrade
      - e2e_multi_cluster_appdb_upgrade_downgrade_v1_27_to_mck
      - e2e_om_update_before_reconciliation
      - e2e_om_feature_controls
      - e2e_multi_cluster_sharded_disaster_recovery
    <<: *teardown_group

  # Dedicated task group for deploying OM Multi-Cluster when the operator is in the central cluster
  # that is not in the mesh
  - name: e2e_multi_cluster_om_operator_not_in_mesh_task_group
    max_hosts: -1
    <<: *setup_group_multi_cluster
    <<: *setup_and_teardown_task
    tasks:
      - e2e_multi_cluster_om_clusterwide_operator_not_in_mesh_networking
    <<: *teardown_group


  # This task group runs on Kind clusters. In theory ALL Ops Manager tests should be added here
  # including the cluster-wide resources changing. Uses Cloud-qa. TODO why Cloud-qa? those are OM tests
  - name: e2e_ops_manager_kind_only_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_appdb_external_connectivity
      - e2e_om_appdb_flags_and_config
      - e2e_om_appdb_monitoring_tls
      - e2e_om_appdb_multi_change
      - e2e_om_appdb_scale_up_down
      - e2e_om_appdb_upgrade
      - e2e_om_appdb_validation
      - e2e_om_appdb_scram
      - e2e_om_external_connectivity
      - e2e_om_jvm_params
      - e2e_om_migration
      - e2e_om_localmode
      - e2e_om_ops_manager_enable_local_mode_running_om
      - e2e_om_localmode_multiple_pv
      - e2e_om_weak_password
      - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
      - e2e_om_ops_manager_backup_light
      - e2e_om_ops_manager_backup_tls
      - e2e_om_ops_manager_backup_s3_tls
      - e2e_om_ops_manager_backup_restore_minio
      - e2e_om_ops_manager_backup_tls_custom_ca
      - e2e_om_ops_manager_backup_liveness_probe
      - e2e_om_ops_manager_backup_sharded_cluster
      - e2e_om_ops_manager_backup_kmip
      - e2e_om_ops_manager_pod_spec
      - e2e_om_ops_manager_https_enabled
      - e2e_om_ops_manager_https_enabled_hybrid
      - e2e_om_ops_manager_https_enabled_internet_mode
      - e2e_om_ops_manager_https_enabled_prefix
      - e2e_om_ops_manager_scale
      - e2e_om_validation_webhook
      - e2e_om_ops_manager_secure_config
      - e2e_om_update_before_reconciliation
      - e2e_om_multiple
      - e2e_om_feature_controls
      - e2e_vault_setup_om
      - e2e_vault_setup_om_backup
    <<: *teardown_group

  - name: e2e_static_ops_manager_kind_only_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_appdb_external_connectivity
      - e2e_om_appdb_flags_and_config
      - e2e_om_appdb_monitoring_tls
      - e2e_om_appdb_multi_change
      - e2e_om_appdb_scale_up_down
      - e2e_om_appdb_upgrade
      - e2e_om_appdb_validation
      - e2e_om_appdb_scram
      - e2e_om_external_connectivity
      - e2e_om_jvm_params
      - e2e_om_weak_password
      - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
      - e2e_om_ops_manager_backup_light
      - e2e_om_ops_manager_backup_tls
      - e2e_om_ops_manager_backup_s3_tls
      - e2e_om_ops_manager_backup_restore_minio
      - e2e_om_ops_manager_backup_tls_custom_ca
      - e2e_om_ops_manager_backup_liveness_probe
      - e2e_om_ops_manager_backup_sharded_cluster
      - e2e_om_ops_manager_backup_kmip
      - e2e_om_ops_manager_pod_spec
      - e2e_om_ops_manager_scale
      - e2e_om_validation_webhook
      - e2e_om_ops_manager_secure_config
      - e2e_om_update_before_reconciliation
      - e2e_om_multiple
      - e2e_om_feature_controls
      - e2e_vault_setup_om
      - e2e_vault_setup_om_backup
    #   Deactivated tests
    #    - e2e_om_localmode_multiple_pv
    #    - e2e_om_localmode
    #    - e2e_om_ops_manager_https_enabled_hybrid
    #    - e2e_om_ops_manager_https_enabled_internet_mode
    #    - e2e_om_ops_manager_https_enabled
    #    - e2e_om_ops_manager_https_enabled_prefix
    <<: *teardown_group

  - name: e2e_smoke_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_ops_manager_backup
    <<: *teardown_group

  - name: e2e_smoke_arm_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_replica_set
    <<: *teardown_group

  - name: e2e_smoke_ibm_task_group
    max_hosts: -1
    <<: *setup_group_ibm
    <<: *setup_and_teardown_task_cloudqa
    tasks:
      - e2e_replica_set
    <<: *teardown_group

  - name: e2e_ops_manager_kind_5_0_only_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_remotemode
      - e2e_om_ops_manager_backup_restore
      - e2e_om_ops_manager_queryable_backup
      - e2e_om_ops_manager_backup
    <<: *teardown_group

  # TODO (CLOUDP-346008): Remove this task group once the issue with queryable backup task is resolved in OM8
  - name: e2e_ops_manager_kind_5_0_only_task_group_without_queryable_backup
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_remotemode
      - e2e_om_ops_manager_backup_restore
      - e2e_om_ops_manager_backup
    <<: *teardown_group

  # Tests features only supported on OM60
  - name: e2e_ops_manager_kind_6_0_only_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_ops_manager_prometheus
    <<: *teardown_group

  # Tests features only supported on OM80
  - name: e2e_ops_manager_kind_8_0_only_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_search_enterprise_tls
      - e2e_search_enterprise_x509_cluster_auth
    <<: *teardown_group

  # Tests features only supported on OM70 and OM80, its only upgrade test as we test upgrading from 6 to 7 or 7 to 8
  - name: e2e_ops_manager_upgrade_only_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_ops_manager_upgrade
    <<: *teardown_group

  # Tests features only supported on OM60
  - name: e2e_static_ops_manager_kind_6_0_only_task_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    tasks:
      - e2e_om_ops_manager_prometheus
    <<: *teardown_group

  - name: e2e_kind_olm_group
    max_hosts: -1
    <<: *setup_group
    <<: *setup_and_teardown_task
    setup_task_can_fail_task: true
    setup_task:
      # Even if the two first tasks are already part of setup_and_teardown_task,
      # we need to repeat them because we are overriding the setup_task variable of the YAML anchor
      - func: cleanup_exec_environment
      - func: configure_docker_auth
      - func: setup_kubernetes_environment
      - func: setup_prepare_openshift_bundles
      - func: install_olm
    tasks:
      - e2e_olm_operator_upgrade
      - e2e_olm_operator_upgrade_with_resources
      - e2e_olm_meko_operator_upgrade_with_resources
    <<: *teardown_group

buildvariants:
  ## Unit tests + lint build variant

  - name: unit_tests
    display_name: "unit_tests"
    tags: [ "pr_patch", "staging", "unit_tests" ]
    run_on:
      - ubuntu2204-small #TODO: Uses older ubuntu2204, because for some reason on ubuntu2404 the helm binary is not found
    tasks:
      - name: "unit_task_group"

  ## Build variants for E2E tests

  # The pattern for naming build variants for E2E tests:
  # e2e_<type>_<cluster>_<distro>[_<om_version>]
  # where <type> is any of mdb|om<version>|operator
  # where <cluster> is any of kind|openshift
  # where <distro> is only ubi
  # where <om_version> denotes the OM version tested (e.g. om50, om60, cloudqa) - used only for MDB tests

  # MongoDBCommunity build variant
  - name: e2e_mdb_community
    display_name: e2e_mdb_community
    tags: [ "pr_patch", "staging", "e2e_test_suite" ]
    run_on:
      - ubuntu2404-large
    <<: *community_dependency
    tasks:
      - name: e2e_mdb_community_task_group

  ## MongoDB build variants
  - name: e2e_mdb_kind_ubi_cloudqa
    display_name: e2e_mdb_kind_ubi_cloudqa
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "cloudqa_non_static" ]
    run_on:
      - ubuntu2404-medium
    <<: *base_no_om_image_dependency
    tasks:
      - name: e2e_mdb_kind_cloudqa_task_group

  - name: e2e_custom_domain_mdb_kind_ubi_cloudqa
    display_name: e2e_custom_domain_mdb_kind_ubi_cloudqa
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "cloudqa_non_static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_no_om_image_dependency
    tasks:
      - name: e2e_custom_domain_task_group

  - name: e2e_static_mdb_kind_ubi_cloudqa
    display_name: e2e_static_mdb_kind_ubi_cloudqa
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "static" ]
    run_on:
      - ubuntu2404-medium
    <<: *base_no_om_image_dependency
    tasks:
      - name: e2e_mdb_kind_cloudqa_task_group

  - name: e2e_static_custom_domain_mdb_kind_ubi_cloudqa
    display_name: e2e_static_custom_domain_mdb_kind_ubi_cloudqa
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "static" ]
    run_on:
      - ubuntu2404-large
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: publish_helm_chart
        variant: init_test_run

    tasks:
      - name: e2e_custom_domain_task_group

  # We do not want to run openshift variants on every PR.
  - name: e2e_mdb_openshift_ubi_cloudqa
    display_name: e2e_mdb_openshift_ubi_cloudqa
    tags: [ "staging", "e2e_openshift_test_suite", "cloudqa", "cloudqa_non_static" ]
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
    run_on:
      - ubuntu2404-small
    tasks:
      - name: e2e_mdb_openshift_ubi_cloudqa_task_group

  # We do not want to run openshift variants on every PR.
  - name: e2e_static_openshift_mdb_ubi_cloudqa
    display_name: e2e_static_openshift_mdb_ubi_cloudqa
    tags: [ "staging", "e2e_openshift_test_suite", "cloudqa", "static" ]
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run

    run_on:
      - ubuntu2404-small
    tasks:
      - name: e2e_mdb_openshift_ubi_cloudqa_task_group

  ## Ops Manager build variants

  # Isolated Ops Manager Tests for 6.0 version - kept for on-demand testing only
  - name: e2e_om60_kind_ubi
    display_name: e2e_om60_kind_ubi
    tags: [ "manual_patch", "e2e_test_suite" ]
    run_on:
      - ubuntu2204-medium-high-memory
    <<: *base_om6_dependency
    tasks:
      - name: e2e_ops_manager_kind_only_task_group
      - name: e2e_ops_manager_kind_5_0_only_task_group
      - name: e2e_ops_manager_kind_6_0_only_task_group

  # Isolated Ops Manager Tests for 6.0 version - kept for on-demand testing only
  - name: e2e_static_om60_kind_ubi
    display_name: e2e_static_om60_kind_ubi
    tags: [ "manual_patch", "e2e_test_suite", "static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om6_dependency
    tasks:
      - name: e2e_static_ops_manager_kind_only_task_group
      - name: e2e_static_ops_manager_kind_6_0_only_task_group

  - name: e2e_om70_kind_ubi
    display_name: e2e_om70_kind_ubi
    tags: [ "pr_patch", "staging", "e2e_test_suite", "patch" ]
    run_on:
      - ubuntu2204-medium-high-memory
    <<: *base_om7_dependency
    tasks:
      - name: e2e_ops_manager_kind_only_task_group
      - name: e2e_ops_manager_kind_5_0_only_task_group
      - name: e2e_ops_manager_kind_6_0_only_task_group
      - name: e2e_ops_manager_upgrade_only_task_group

  - name: e2e_static_om70_kind_ubi
    display_name: e2e_static_om70_kind_ubi
    tags: [ "pr_patch", "staging", "e2e_test_suite", "static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_static_ops_manager_kind_only_task_group
      - name: e2e_static_ops_manager_kind_6_0_only_task_group
      - name: e2e_ops_manager_upgrade_only_task_group

  - name: e2e_om80_kind_ubi
    display_name: e2e_om80_kind_ubi
    tags: [ "pr_patch", "staging", "e2e_test_suite" ]
    run_on:
      - ubuntu2204-medium-high-memory
    <<: *base_om8_dependency
    tasks:
      - name: e2e_ops_manager_kind_only_task_group
      # TODO (CLOUDP-346008): Replace this task group with e2e_ops_manager_kind_5_0_only_task_group once the issue with queryable backup task is resolved in OM8
      - name: e2e_ops_manager_kind_5_0_only_task_group_without_queryable_backup
      - name: e2e_ops_manager_kind_6_0_only_task_group
      - name: e2e_ops_manager_upgrade_only_task_group
      - name: e2e_ops_manager_kind_8_0_only_task_group

  - name: e2e_static_om80_kind_ubi
    display_name: e2e_static_om80_kind_ubi
    tags: [ "pr_patch", "staging", "e2e_test_suite", "static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om8_dependency
    tasks:
      - name: e2e_static_ops_manager_kind_only_task_group
      - name: e2e_static_ops_manager_kind_6_0_only_task_group
      - name: e2e_ops_manager_upgrade_only_task_group

  - name: e2e_operator_race_ubi_with_telemetry
    display_name: e2e_operator_race_ubi_with_telemetry
    tags: [ "pr_patch", "staging", "e2e_test_suite" ]
    run_on:
      - ubuntu2404-xlarge
    <<: *base_om7_dependency_with_race
    tasks:
      - name: e2e_operator_race_with_telemetry_task_group

  - name: e2e_smoke_ibm_power
    display_name: e2e_smoke_ibm_power
    tags: [ "staging", "e2e_smoke_test_suite" ]
    run_on:
      - rhel9-power-small
      - rhel9-power-large
    allowed_requesters: [ "patch", "commit" ]
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image_ibm_power
        variant: init_test_run_ibm_power
      - name: publish_helm_chart
        variant: init_test_run
    tasks:
      - name: e2e_smoke_ibm_task_group

  - name: e2e_static_smoke_ibm_power
    display_name: e2e_static_smoke_ibm_power
    tags: [ "staging", "e2e_smoke_test_suite", "static" ]
    run_on:
      - rhel9-power-small
      - rhel9-power-large
    allowed_requesters: [ "patch", "commit" ]
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image_ibm_power
        variant: init_test_run_ibm_power
      - name: publish_helm_chart
        variant: init_test_run
    tasks:
      - name: e2e_smoke_ibm_task_group

  - name: e2e_smoke_ibm_z
    display_name: e2e_smoke_ibm_z
    tags: [ "staging", "e2e_smoke_test_suite" ]
    run_on:
      - rhel9-zseries-small
      - rhel9-zseries-large
    allowed_requesters: [ "patch", "commit" ]
    # TODO: Re-enable when ibm_z series is stable
    # https://jira.mongodb.org/browse/DEVPROD-23283
    disable: true
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image_ibm_z
        variant: init_test_run_ibm_z
      - name: publish_helm_chart
        variant: init_test_run
    tasks:
      - name: e2e_smoke_ibm_task_group

  - name: e2e_static_smoke_ibm_z
    display_name: e2e_static_smoke_ibm_z
    tags: [ "staging", "e2e_smoke_test_suite", "static" ]
    # TODO: Re-enable when ibm_z series is stable
    # https://jira.mongodb.org/browse/DEVPROD-23283
    disable: true
    run_on:
      - rhel9-zseries-small
      - rhel9-zseries-large
    allowed_requesters: [ "patch", "commit" ]
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_test_image_ibm_z
        variant: init_test_run_ibm_z
      - name: publish_helm_chart
        variant: init_test_run
    tasks:
      - name: e2e_smoke_ibm_task_group

  - name: e2e_smoke_arm
    display_name: e2e_smoke_arm
    tags: [ "staging", "e2e_smoke_test_suite" ]
    run_on:
      - ubuntu2404-arm64-large
    allowed_requesters: [ "patch", "commit" ]
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image_arm
        variant: init_test_run_arm
      - name: publish_helm_chart
        variant: init_test_run
    tasks:
      - name: e2e_smoke_arm_task_group

  - name: e2e_static_smoke_arm
    display_name: e2e_static_smoke_arm
    tags: [ "staging", "e2e_smoke_test_suite", "static" ]
    run_on:
      - ubuntu2404-arm64-large
    allowed_requesters: [ "patch", "commit" ]
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_test_image_arm
        variant: init_test_run_arm
      - name: publish_helm_chart
        variant: init_test_run
    tasks:
      - name: e2e_smoke_arm_task_group

  - name: e2e_multi_cluster_kind
    display_name: e2e_multi_cluster_kind
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "cloudqa_non_static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_multi_cluster_kind_task_group

  - name: e2e_static_multi_cluster_kind
    display_name: e2e_static_multi_cluster_kind
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_multi_cluster_kind_task_group

  - name: e2e_multi_cluster_2_clusters
    display_name: e2e_multi_cluster_2_clusters
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "cloudqa_non_static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_multi_cluster_2_clusters_task_group

  - name: e2e_static_multi_cluster_2_clusters
    display_name: e2e_static_multi_cluster_2_clusters
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_multi_cluster_2_clusters_task_group

  - name: e2e_multi_cluster_om_appdb
    display_name: e2e_multi_cluster_om_appdb
    tags: [ "pr_patch", "staging", "e2e_test_suite" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_multi_cluster_om_appdb_task_group

  - name: e2e_static_multi_cluster_om_appdb
    display_name: e2e_static_multi_cluster_om_appdb
    tags: [ "pr_patch", "staging", "e2e_test_suite", "static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_static_multi_cluster_om_appdb_task_group

  - name: e2e_multi_cluster_om_operator_not_in_mesh
    display_name: e2e_multi_cluster_om_operator_not_in_mesh
    tags: [ "pr_patch", "staging", "e2e_test_suite" ]
    run_on:
      - ubuntu2404-large
    <<: *base_om7_dependency
    tasks:
      - name: e2e_multi_cluster_om_operator_not_in_mesh_task_group

  ## Operator tests build variants

  - name: e2e_operator_kind_ubi_cloudqa
    display_name: e2e_operator_kind_ubi_cloudqa
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "cloudqa_non_static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_no_om_image_dependency
    tasks:
      - name: e2e_operator_task_group

  - name: e2e_static_operator_kind_ubi_cloudqa
    display_name: e2e_static_operator_kind_ubi_cloudqa
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_no_om_image_dependency
    tasks:
      - name: e2e_static_operator_task_group

  - name: e2e_operator_no_webhook_roles_cloudqa
    display_name: e2e_operator_no_webhook_roles_cloudqa
    tags: [ "pr_patch", "staging", "e2e_test_suite", "cloudqa", "cloudqa_non_static" ]
    run_on:
      - ubuntu2404-large
    <<: *base_no_om_image_dependency
    tasks:
      - name: e2e_mdb_kind_no_webhook_roles_cloudqa_task_group

  - name: e2e_kind_olm_ubi
    display_name: e2e_kind_olm_ubi
    tags: [ "pr_patch", "staging", "e2e_test_suite" ]
    run_on:
      - ubuntu2404-large
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: prepare_and_upload_openshift_bundles_for_e2e
        variant: init_tests_with_olm
    tasks:
      - name: e2e_kind_olm_group

  - name: e2e_static_kind_olm_ubi
    display_name: e2e_static_kind_olm_ubi
    tags: [ "pr_patch", "staging", "e2e_test_suite", "static" ]
    run_on:
      - ubuntu2404-large
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: prepare_and_upload_openshift_bundles_for_e2e
        variant: init_tests_with_olm
      - name: build_init_database_image_ubi
        variant: init_test_run
    tasks:
      - name: e2e_kind_olm_group

    # This variants runs the tests from MCO with the MEKO operator binary
  - name: e2e_mco_tests
    display_name: "e2e_mco_tests"
    tags: [ "pr_patch", "staging", "e2e_mco_test_suite" ]
    <<: *community_dependency
    run_on:
      - ubuntu2404-large

  ## Manual (patch) E2E tests not run for every PR and commit

  - name: e2e_operator_perf
    display_name: e2e_operator_perf
    tags: [ "manual_patch", "e2e_perf_test_suite" ]
    allowed_requesters: [ "patch" ]
    run_on:
      - ubuntu1804-xlarge
    <<: *base_om7_dependency
    tasks:
      - name: generate_perf_tasks_10_thread

  - name: e2e_operator_perf_one_thread
    display_name: e2e_operator_perf_one_thread
    tags: [ "manual_patch", "e2e_perf_test_suite" ]
    allowed_requesters: [ "patch" ]
    run_on:
      - ubuntu1804-xlarge
    <<: *base_om7_dependency
    tasks:
      - name: generate_perf_tasks_one_thread

  - name: e2e_operator_perf_thirty
    display_name: e2e_operator_perf_thirty
    tags: [ "manual_patch", "e2e_perf_test_suite" ]
    allowed_requesters: [ "patch" ]
    run_on:
      - ubuntu1804-xlarge
    <<: *base_om7_dependency
    tasks:
      - name: generate_perf_tasks_30_thread

  ### Prerequisites for E2E test suite

  - name: init_test_run
    display_name: init_test_run
    max_hosts: -1
    tags: [ "pr_patch", "staging" ]
    run_on:
      - ubuntu2404-small
    tasks:
      - name: build_operator_ubi
      - name: build_operator_race_ubi
      - name: build_test_image
        depends_on:
          - name: build_kubectl_mongodb_plugin
      - name: build_mco_test_image
      - name: build_init_appdb_images_ubi
      - name: build_init_om_images_ubi
      - name: build_init_database_image_ubi
      - name: build_database_image_ubi
      - name: build_agent_images_ubi
      - name: build_readiness_probe_image
      - name: build_version_upgrade_hook_image
      - name: build_kubectl_mongodb_plugin
      - name: prepare_aws
      - name: publish_helm_chart

  - name: init_test_run_ibm_power
    display_name: init_test_run_ibm_power
    max_hosts: -1
    tags: [ "staging" ]
    run_on:
      - rhel9-power-small
      - rhel9-power-large
    depends_on:
      - name: build_kubectl_mongodb_plugin
        variant: init_test_run
    tasks:
      - name: build_test_image_ibm_power

  - name: init_test_run_ibm_z
    display_name: init_test_run_ibm_z
    max_hosts: -1
    tags: [ "staging" ]
    # TODO: Re-enable when ibm_z series is stable
    # https://jira.mongodb.org/browse/DEVPROD-23283
    disable: true
    run_on:
      - rhel9-zseries-small
      - rhel9-zseries-large
    depends_on:
      - name: build_kubectl_mongodb_plugin
        variant: init_test_run
    tasks:
      - name: build_test_image_ibm_z

  - name: init_test_run_arm
    display_name: init_test_run_arm
    max_hosts: -1
    tags: [ "staging" ]
    run_on:
      - ubuntu2204-arm64-small
    depends_on:
      - name: build_kubectl_mongodb_plugin
        variant: init_test_run
    tasks:
      - name: build_test_image_arm

  - name: run_pre_commit
    priority: 70
    display_name: run_pre_commit
    allowed_requesters: [ "patch", "github_pr" ]
    tags: [ "pr_patch", "auto_bump" ]
    run_on:
      - ubuntu2404-small
    tasks:
      - name: run_conditionally_precommit_and_push

  - name: init_tests_with_olm
    display_name: init_tests_with_olm
    depends_on:
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
    tags: [ "pr_patch", "staging" ]
    run_on:
      - ubuntu2404-small
    tasks:
      - name: prepare_and_upload_openshift_bundles_for_e2e

  ### End of build variants for E2E

  ### Variants that run on each commit

  - name: preflight_release_images_check_only
    display_name: preflight_release_images_check_only
    tags: [ "staging" ]
    run_on:
      - rhel90-large
    expansions:
      preflight_submit: false
    tasks:
      - name: preflight_images_task_group

  # OM60 images build - kept for on-demand testing only
  - name: build_om60_images
    display_name: build_om60_images
    tags: [ "manual_patch" ]
    run_on:
      - ubuntu2404-small
    tasks:
      - name: build_om_images

  - name: build_om70_images
    display_name: build_om70_images
    tags: [ "pr_patch", "staging" ]
    run_on:
      - ubuntu2404-small
    tasks:
      - name: build_om_images

  - name: build_om80_images
    display_name: build_om80_images
    tags: [ "pr_patch", "staging" ]
    run_on:
      - ubuntu2404-small
    tasks:
      - name: build_om_images

    # Only called manually, It's used for testing the task release_agents in case the release.json
    # has not changed, and you still want to push the images to registry.
  - name: manual_release_all_agents
    display_name: Manual Agent Release for all versions
    tags: [ "manual_patch", "release_all_agents_manually" ]
    run_on:
      - ubuntu2404-large
    tasks:
      - name: rebuild_all_agents

    # Only called manually, It's used for testing the task release_agents in case the release.json
    # has not changed, and you still want to push the images to registry.
  - name: manual_release_agent_currently_used
    display_name: manual_release_agent_currently_used
    tags: [ "manual_patch", "release_current_agents_manually" ]
    run_on:
      - ubuntu2404-large
    tasks:
      - name: rebuild_currently_used_agents

  ### Build variants for manual patch only

  - name: backup_csv_images
    display_name: "Backup CSV Images"
    tags: [ "manual_patch" ]
    allowed_requesters: [ "patch" ]
    run_on:
      - ubuntu2404-small
    tasks:
      - name: backup_csv_images_dry_run
      - name: backup_csv_images_limit_3
      - name: backup_csv_images_all

  - name: publish_om70_images
    display_name: publish_om70_images
    tags: [ "manual_patch" ]
    allowed_requesters: [ "patch", "github_pr" ]
    run_on:
      - release-ubuntu2404-small # This is required for CISA attestation https://jira.mongodb.org/browse/DEVPROD-17780
    depends_on:
      - variant: e2e_om70_kind_ubi
        name: '*'
      - variant: e2e_static_om70_kind_ubi
        name: '*'
    tasks:
      - name: publish_ops_manager
      - name: release_agent

  - name: publish_om80_images
    display_name: publish_om80_images
    tags: [ "manual_patch" ]
    allowed_requesters: [ "patch", "github_pr" ]
    run_on:
      - release-ubuntu2404-small # This is required for CISA attestation https://jira.mongodb.org/browse/DEVPROD-17780
    depends_on:
      - variant: e2e_om80_kind_ubi
        name: '*'
      - variant: e2e_static_om80_kind_ubi
        name: '*'
    tasks:
      - name: publish_ops_manager
      - name: release_agent

  - name: migrate_all_agents
    display_name: migrate_all_agents
    tags: [ "manual_patch" ]
    allowed_requesters: [ "patch" ]
    run_on:
      - ubuntu2404-large
    tasks:
      - name: migrate_all_agents

  # Runs on every merge to master and releases images auxiliary to the operator release like OM and the Agent
  - name: release_om_and_agents
    display_name: release_om_and_agents
    allowed_requesters: [ "patch" , "commit"]
    run_on:
      - release-ubuntu2404-small
    patchable: false  # Only run on commit builds
    tasks:
      - name: release_om_and_agents
