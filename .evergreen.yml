# 2h timeout for all the tasks
exec_timeout_secs: 7200

variables:
  - &ops_manager_60_latest 6.0.25 # The order/index is important, since these are anchors. Please do not change

  - &ops_manager_70_latest 7.0.9 # The order/index is important, since these are anchors. Please do not change

# The dependency unification between static and non-static is intentional here.
# Even though some images are exclusive, in EVG they all are built once and in parallel.
# It is not worth the effort of splitting them out.
# Once Static Containers are default, this piece can be cleaned up.
  - &base_om6_dependency
    depends_on:
      - name: build_om_images
        variant: build_om60_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_agent_images_ubi
        variant: init_test_run

  - &base_no_om_image_dependency
    depends_on:
      - name: build_om_images
        variant: build_om70_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_agent_images_ubi
        variant: init_test_run

  - &setup_group
    setup_group:
      - func: clone
      - func: download_kube_tools
      - func: setup_building_host

  - &setup_group_multi_cluster
    setup_group:
      - func: clone
      - func: download_kube_tools
      - func: setup_building_host
      - func: build_multi_cluster_binary

  - &setup_and_teardown_task_cloudqa
    setup_task:
      - func: cleanup_exec_environment
      - func: setup_kubernetes_environment
      - func: setup_cloud_qa
    teardown_task:
      - func: upload_e2e_logs
      - func: teardown_kubernetes_environment
      - func: teardown_cloud_qa        

  - &setup_and_teardown_task
    setup_task:
      - func: cleanup_exec_environment
      - func: setup_kubernetes_environment
    teardown_task:
      - func: upload_e2e_logs
      - func: teardown_kubernetes_environment

  - &teardown_group
    teardown_group:
      - func: prune_docker_resources
      - func: run_retry_script

  - &base_om7_dependency
    depends_on:
      - name: build_om_images
        variant: build_om70_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_agent_images_ubi
        variant: init_test_run

  - &e2e_include_expansions_in_env
    include_expansions_in_env:
      - ecr_registry
      - ecr_registry_needs_auth
      - GITHUB_TOKEN_READ
      - openshift_url
      - openshift_token
      - workdir
      - mms_eng_test_aws_access_key
      - mms_eng_test_aws_secret
      - mms_eng_test_aws_region
      - OVERRIDE_VERSION_ID
      - version_id
      - task_name
      - e2e_cloud_qa_user_owner_ubi_cloudqa
      - e2e_cloud_qa_apikey_owner_ubi_cloudqa
      - e2e_cloud_qa_orgid_owner_ubi_cloudqa
      - e2e_cloud_qa_user_owner_ubi_cloudqa_2
      - e2e_cloud_qa_apikey_owner_ubi_cloudqa_2
      - e2e_cloud_qa_orgid_owner_ubi_cloudqa_2
      - e2e_cloud_qa_user_owner_static
      - e2e_cloud_qa_apikey_owner_static
      - e2e_cloud_qa_orgid_owner_static
      - e2e_cloud_qa_user_owner_static_2
      - e2e_cloud_qa_apikey_owner_static_2
      - e2e_cloud_qa_orgid_owner_static_2
      - otel_trace_id
      - otel_collector_endpoint
      - branch_name
      - is_patch
      - github_commit
      - build_variant
      - execution
      - build_id

parameters:
- key: evergreen_retry
  value: "true"
  description: set this to false to suppress retries on failure

- key: pin_tag_at
  value: 10:00
  description: Pin tags at this time of the day. Midnight by default for periodic and 10 for releases.

- key: OVERRIDE_VERSION_ID
  value: ""
  description: "Patch id to reuse images from other Evergreen build"

functions:

  setup_context: &setup_context # Running the first switch is important to fill the workdir and other important initial env vars
    command: shell.exec
    type: setup
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      <<: *e2e_include_expansions_in_env
      script: |
        echo "Initializing context files"
        cp scripts/dev/contexts/evg-private-context scripts/dev/contexts/private-context
        scripts/dev/switch_context.sh root-context
        echo "Finished initializing to the root context"

  switch_context: &switch_context
    command: shell.exec
    type: setup
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      <<: *e2e_include_expansions_in_env
      script: |
        echo "Switching context"
        scripts/dev/switch_context.sh "${build_variant}"
        echo "Finished switching context"

  python_venv: &python_venv
    command: subprocess.exec
    type: setup
    params:
      command: /opt/python/3.9/bin/python3 -m venv --upgrade-deps ./venv

  "clone":
    - command: subprocess.exec
      type: setup
      params:
        command: "mkdir -p src/github.com/10gen"
    - command: git.get_project
      type: setup
      params:
        directory: src/github.com/10gen/ops-manager-kubernetes
    - *setup_context

  build_multi_cluster_binary:
  - command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/build_multi_cluster_kubeconfig_creator.sh

  python_requirements: &python_requirements
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/run_python.sh -m pip install -r requirements.txt --quiet --no-warn-script-location

  test_operator:
  - *python_venv
  - *python_requirements
  - command: shell.exec
    type: test
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      script: |
        source .generated/context.export.env
        make test-race

  test_sboms:
    - *python_venv
    - *python_requirements
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        script: |
          source .generated/context.export.env
          make sbom-tests

  setup_preflight:
  - command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
        - ${workdir}/bin
      binary: scripts/evergreen/setup_preflight.sh
  - command: subprocess.exec
    type: setup
    params:
      command: python3 -m venv --upgrade ./venv
  - command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/run_python.sh -m pip install -r requirements.txt

  preflight_image:
  - *switch_context
  - command: subprocess.exec
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
        - ${workdir}/bin
      include_expansions_in_env:
        - image_version
        - rh_pyxis
      binary: scripts/evergreen/run_python.sh scripts/preflight_images.py --image ${image_name} --submit "${preflight_submit}"

  pipeline:
  - *python_venv
  - *python_requirements
  - *switch_context
  - command: subprocess.exec
    retry_on_failure: true
    type: setup
    params:
      shell: bash
      include_expansions_in_env:
        - version_id
        - registry
        - image_name
        - skip_tags
        - include_tags
        - distro
        - is_patch
        - GRS_USERNAME
        - GRS_PASSWORD
        - PKCS11_URI
        - ARTIFACTORY_USERNAME
        - ARTIFACTORY_PASSWORD
        - triggered_by_git_tag
        - pin_tag_at
        - SILK_CLIENT_ID
        - SILK_CLIENT_SECRET
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/run_python.sh pipeline.py --include ${image_name} --parallel --sign


  upload_dockerfiles:
  - command: s3.put
    params:
      aws_key: ${enterprise_aws_access_key_id}
      aws_secret: ${enterprise_aws_secret_access_key}
      local_file: src/github.com/10gen/ops-manager-kubernetes/public/dockerfiles-${triggered_by_git_tag}.tgz
      remote_file: bundles/dockerfiles-${triggered_by_git_tag}.tgz
      bucket: operator-e2e-bundles
      permissions: public-read
      content_type: application/x-binary

  # upload_e2e_logs has the responsibility of dumping as much information as
  # possible into the S3 bucket that corresponds to this ${version}. The
  # Kubernetes cluster where the test finished running, should still be
  # reachable. Note that after a timeout, Evergreen kills the running process
  # and any running container in the host (which kills Kind).
  upload_e2e_logs:
    - command: s3.put
      params:
        aws_key: ${enterprise_aws_access_key_id}
        aws_secret: ${enterprise_aws_secret_access_key}
        local_files_include_filter:
          - src/github.com/10gen/ops-manager-kubernetes/logs/*
        remote_file: logs/${task_id}/${execution}/
        bucket: operator-e2e-artifacts
        permissions: public-read
        content_type: text/plain
    - command: attach.xunit_results
      params:
        file: "src/github.com/10gen/ops-manager-kubernetes/logs/myreport.xml"


  # cleanup_exec_environment is a very generic name when the only thing this function
  # does is to clean the logs directory. In the future, more "commands" can be
  # added to it with more clearing features, when needed.
  cleanup_exec_environment:
  - command: shell.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      script: |
        rm -rf logs

  quay_login:
  - command: subprocess.exec
    type: setup
    params:
      command: "docker login quay.io -u ${quay_prod_username} -p ${quay_prod_robot_token}"

  # Logs into all used registries
  configure_docker_auth: &configure_docker_auth
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
      - ${workdir}/bin
      binary: scripts/dev/configure_docker_auth.sh

  lint_repo:
  - *python_venv
  - *python_requirements
  - command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
        - ${workdir}/bin
      command: scripts/evergreen/setup_yq.sh

  - command: subprocess.exec
    type: test
    params:
      add_to_path:
        - ${workdir}/bin
        - ${workdir}/venv/bin
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      include_expansions_in_env:
        - GITHUB_TOKEN_READ
      binary: scripts/evergreen/check_precommit.sh

  setup_kubectl: &setup_kubectl
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/setup_kubectl.sh

  setup_jq: &setup_jq
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/setup_jq.sh

  setup_shellcheck:
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
        - ${workdir}/bin
      binary: scripts/evergreen/setup_shellcheck.sh

  setup_aws: &setup_aws
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
        - ${workdir}/bin
      binary: scripts/evergreen/setup_aws.sh

  # configures Docker size, installs the Kind binary (if necessary)
  setup_kind: &setup_kind
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
        - ${workdir}/bin
      binary: scripts/evergreen/setup_kind.sh

  setup_docker_datadir: &setup_docker_datadir
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/configure-docker-datadir.sh

  # Configures docker authentication to ECR and RH registries.
  setup_building_host:
  - *switch_context
  - *setup_aws
  - *configure_docker_auth
  - *setup_docker_datadir

  prune_docker_resources:
  - command: subprocess.exec
    type: setup
    params:
      command: "docker system prune -a -f"

  # the task configures the set of tools necessary for any task working with K8 cluster:
  # installs kubectl, jq, kind (if necessary), configures docker authentication
  download_kube_tools:
    - *switch_context
    - *setup_kubectl
    - *setup_jq
      # we need aws to configure docker authentication
    - *setup_aws
    - *configure_docker_auth
    - *setup_kind

  teardown_kubernetes_environment:
  - command: shell.exec
    type: setup
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      script: |
        scripts/evergreen/teardown_kubernetes_environment.sh

  # Makes sure a kubectl context is defined.
  setup_kubernetes_environment_p: &setup_kubernetes_environment_p
    command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      add_to_path:
      - ${workdir}/bin
      binary: scripts/evergreen/setup_kubernetes_environment.sh

  setup_kubernetes_environment:
  - *setup_kubernetes_environment_p
  # After setting up KUBE, we need to update the KUBECONFIG and other env vars.
  - *switch_context

  generate_perf_tests_tasks:
  - *switch_context
  - *python_venv
  - *python_requirements
  - command: shell.exec
    type: setup
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      script: |
        source .generated/context.export.env
        scripts/evergreen/run_python.sh scripts/evergreen/e2e/performance/create_variants.py ${variant} ${size}> evergreen_tasks.json
        echo "tasks to run:"
        cat evergreen_tasks.json
  - command: generate.tasks
    params:
      files:
        - evergreen_tasks.json

  setup_cloud_qa:
  - *switch_context
  - command: shell.exec
    type: setup
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      script: |
        source .generated/context.export.env
        scripts/evergreen/e2e/setup_cloud_qa.py create
  # The additional switch is needed, since we now have created the needed OM exports.
  - *switch_context

  teardown_cloud_qa:
  - command: shell.exec
    type: setup
    params:
      shell: bash
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      script: |
        source .generated/context.export.env
        scripts/evergreen/e2e/setup_cloud_qa.py delete

  # Tags and pushes an image into an external Docker registry. The source image
  # needs to exist before it can be pushed to a remote registry.
  # It is expected that IMAGE_SOURCE is accessible with no authentication (like a
  # local image), and the IMAGE_TARGET will be authenticated with DOCKER_* series of
  # environment variables.
  release_docker_image_to_registry:
    - command: subprocess.exec
      type: system
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        add_to_path:
        - ${workdir}/bin
        include_expansions_in_env:
        - tag_source
        - tag_dest
        - image_source
        - image_target
        - docker_username
        - docker_password
        binary: scripts/evergreen/tag_push_docker_image.sh

  #
  # e2e_test is the main function used to run the e2e tests. It expects Ops
  # Manager to be running (local to the Kubernetes cluster or Cloud Manager) and
  # its configuration to exist in a ${workdir}/.ops-manager-env file.
  #
  # The e2e script will run all the tasks that are needed by the e2e tests like
  # fetching the OM API credentials to use and create the Secret and ConfigMap
  # objects that are required.
  #
  # At this point, the Kubernetes environment should be configured already
  # (kubectl configuration points to the Kubernetes cluster where we run the tests).
  #
  # Please note: There are many ENV variables passed to the `e2e` script, so try
  # to not add more. If this is required, discuss your use case with the team first.
  #
  e2e_test:
    - command: subprocess.exec
      type: test
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        include_expansions_in_env:
        - otel_parent_id
        - branch_name
        - github_commit
        - revision
        - github_pr_number
        - project_identifier
        - revision_order_id
        add_to_path:
        - ${workdir}/bin
        binary: scripts/evergreen/e2e/e2e.sh

  e2e_test_perf:
    - command: subprocess.exec
      type: test
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        include_expansions_in_env:
          - otel_parent_id
          - branch_name
          - github_commit
          - revision
          - github_pr_number
          - project_identifier
          - revision_order_id
        add_to_path:
          - ${workdir}/bin
        env:
          PERF_TASK_DEPLOYMENTS: ${PERF_TASK_DEPLOYMENTS}
          PERF_TASK_REPLICAS: ${PERF_TASK_REPLICAS}
          TEST_NAME_OVERRIDE: ${TEST_NAME_OVERRIDE}
        binary: scripts/evergreen/e2e/e2e.sh

  run_retry_script:
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        include_expansions_in_env:
          - EVERGREEN_API_KEY
          - EVERGREEN_USER
          - evergreen_retry
        env:
          EVERGREEN_RETRY: ${evergreen_retry}
        script: |
          scripts/evergreen/retry-evergreen.sh ${version_id}

  #
  # Performs some AWS cleanup
  #
  prepare_aws:
    - command: subprocess.exec
      type: setup
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        add_to_path:
        - ${workdir}/bin
        command: scripts/evergreen/prepare_aws.sh

  build-dockerfiles:
  - *python_venv
  - *python_requirements
  - command: subprocess.exec
    type: setup
    params:
      add_to_path:
      - ${workdir}/bin
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      binary: scripts/evergreen/run_python.sh scripts/update_supported_dockerfiles.py
  - command: subprocess.exec
    type: setup
    params:
      working_dir: src/github.com/10gen/ops-manager-kubernetes
      include_expansions_in_env:
      - triggered_by_git_tag
      # if you ever change the target folder structure, the same needs to be reflected in PCT
      command: "tar -czvf ./public/dockerfiles-${triggered_by_git_tag}.tgz ./public/dockerfiles"

  setup_prepare_openshift_bundles:
    - command: subprocess.exec
      type: setup
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        add_to_path:
          - ${workdir}/bin
        command: scripts/evergreen/setup_yq.sh
    - command: subprocess.exec
      type: setup
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        add_to_path:
          - ${workdir}/bin
        command: scripts/evergreen/setup_prepare_openshift_bundles.sh

  install_olm:
    - command: subprocess.exec
      type: setup
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        add_to_path:
          - ${workdir}/bin
        command: scripts/evergreen/operator-sdk/install-olm.sh

  prepare_openshift_bundles_for_e2e:
    - command: subprocess.exec
      type: setup
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        add_to_path:
          - ${workdir}/bin
        command: scripts/evergreen/operator-sdk/prepare-openshift-bundles-for-e2e.sh

  setup_docker_sbom:
    - command: subprocess.exec
      type: setup
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        binary: scripts/evergreen/setup_docker_sbom.sh

tasks:
- name: preflight_release_images
  commands:
  - func: clone
  - func: setup_preflight
  - func: preflight_image
    vars:
      image_name: operator
  - func: preflight_image
    vars:
      image_name: init-appdb
  - func: preflight_image
    vars:
      image_name: init-database
  - func: preflight_image
    vars:
      image_name: init-ops-manager
  - func: preflight_image
    vars:
      image_name: database
  - func: preflight_image
    vars:
      image_name: mongodb-agent

- name: preflight_om_image
  commands:
  - func: clone
  - func: setup_preflight
  - func: preflight_image
    vars:
      image_name: ops-manager

- name: unit_tests
  tags: ["unit_tests"]
  commands:
    - func: "test_operator"

- name: sbom_tests
  tags: ["unit_tests"]
  # The SBOM tests run only on commit builds. Running this on patches might cause false-positive failures
  # because certain images might not be there yet. Such situation happens for OM image upgrades for example.
  # See https://docs.devprod.prod.corp.mongodb.com/evergreen/Project-Configuration/Project-Configuration-Files#limiting-when-a-task-or-variant-will-run
  patchable: false
  commands:
    - func: "test_sboms"

- name: lint_repo
  tags: ["unit_tests"]
  commands:
    - func: lint_repo

- name: release_operator
  tags: ["image_release"]
  git_tag_only: true
  commands:
  - func: clone
  - func: setup_building_host
  - func: quay_login
  - func: setup_docker_sbom
  - func: pipeline
    vars:
      image_name: operator

- name: upload_dockerfiles
  tags: ["image_release"]
  git_tag_only: true
  # CLOUDP-182323 This ensures that there will be Operator Dockerfile available in S3 before
  # syncing and uploading the bundle TAR archive.
  depends_on:
    - name: release_operator
      variant: release
  commands:
    - func: clone
    - func: setup_building_host
    - func: build-dockerfiles
    - func: upload_dockerfiles

# Releases init images to Quay
- name: release_init_appdb
  tags: ["image_release"]
  git_tag_only: true
  commands:
  - func: clone
  - func: setup_building_host
  - func: quay_login
  - func: setup_docker_sbom
  - func: pipeline
    vars:
      image_name: init-appdb

- name: release_init_database
  tags: ["image_release"]
  git_tag_only: true
  commands:
  - func: clone
  - func: setup_building_host
  - func: quay_login
  - func: setup_docker_sbom
  - func: pipeline
    vars:
      image_name: init-database

- name: release_init_ops_manager
  tags: ["image_release"]
  git_tag_only: true
  commands:
  - func: clone
  - func: setup_building_host
  - func: quay_login
  - func: setup_docker_sbom
  - func: pipeline
    vars:
      image_name: init-ops-manager
      include_tags: release

# pct only triggers this variant once a new agent image is out
- name: release_agent
  # this enables us to run this variant either manually (patch) which pct does or during an OM bump (github_pr)
  allowed_requesters: ["patch", "github_pr"]
  commands:
    - func: clone
    - func: setup_building_host
    - func: quay_login
    - func: setup_docker_sbom
    - func: pipeline
      vars:
        image_name: agent-pct
        include_tags: release

# Pct only triggers this variant once a new agent image is out
# these releases the agent with the operator suffix (not patch id) on ecr to allow for digest pinning to pass.
# For this to work, we rely on skip_tags which is used to determine whether
# we want to release on quay or not, in this case - ecr instead.
# We rely on the init_database from ecr for the agent x operator images.
# This runs on agent releases that are not concurrent with operator releases.
- name: release_agents_on_ecr_conditional
  # this enables us to run this variant either manually (patch) which pct does or during an OM bump (github_pr)
  allowed_requesters: ["patch", "github_pr"]
  commands:
    - func: clone
    - func: setup_building_host
    - command: shell.exec
      params:
        working_dir: src/github.com/10gen/ops-manager-kubernetes
        script: |
          git fetch origin
          if git diff --quiet -- release.json && git diff --quiet origin/master -- release.json; then
            echo "skipping since release.json has not changed"
          else
            echo "release.json has changed, triggering ecr agent release"
            echo "git diff"
            git diff -- release.json
            echo "diff master"
            git diff origin/master
            scripts/evergreen/add_evergreen_task.sh init_release_agents_on_ecr release_agents_on_ecr
          fi
    - command: generate.tasks
      params:
        files:
          - evergreen_tasks.json
        optional: true

- name: release_agents_on_ecr
  # this enables us to run this variant either manually (patch) which pct does or during an OM bump (github_pr)
  allowed_requesters: ["patch", "github_pr"]
  priority: 70
  commands:
    - func: clone
    - func: setup_building_host
    - func: pipeline
      vars:
        image_name: agent-pct
        skip_tags: release

- name: release_agent_operator_release
  tags: ["image_release"]
  git_tag_only: true
  # Once we release the operator, we will also release the init databases, we require them to be out first
  # such that we can reference them and retrieve those binaries.
  # Since we immediately run daily rebuild after creating the image, we can ensure that the init_database is out
  # such that the agent image build can use it.
  depends_on:
    - name: release_init_database
      variant: release
  commands:
    - func: clone
    - func: setup_building_host
    - func: quay_login
    - func: pipeline
      vars:
        image_name: agent
        include_tags: release

- name: build_test_image
  priority: 60
  commands:
  - func: clone
  - func: setup_building_host
  - func: build_multi_cluster_binary
  - func: pipeline
    vars:
      image_name: test

- name: build_operator_ubi
  priority: 60
  commands:
  - func: clone
  - func: setup_building_host
  - func: pipeline
    vars:
      skip_tags: ubuntu,release
      distro: ubi
      image_name: operator

- name: build_init_om_images_ubi
  priority: 60
  commands:
  - func: clone
  - func: setup_building_host
  - func: pipeline
    vars:
      image_name: init-ops-manager
      skip_tags: ubuntu,release

- name: build_init_appdb_images_ubi
  commands:
  - func: clone
  - func: setup_building_host
  - func: pipeline
    vars:
      image_name: init-appdb
      skip_tags: ubuntu,release

- name: build_agent_images_ubi
  depends_on:
    - name: build_init_database_image_ubi
      variant: init_test_run
  commands:
    - func: clone
    - func: setup_building_host
    - func: pipeline
      vars:
        image_name: agent
        skip_tags: ubuntu,release

- name: build_init_database_image_ubi
  commands:
  - func: clone
  - func: setup_building_host
  - func: pipeline
    vars:
      image_name: init-database
      skip_tags: ubuntu,release

- name: build_database_image_ubi
  commands:
  - func: clone
  - func: setup_building_host
  - func: pipeline
    vars:
      image_name: database
      skip_tags: ubuntu,release

- name: prepare_aws
  priority: 59
  commands:
    - func: clone
    - func: setup_jq
    - func: setup_aws
    - func: prepare_aws

- name: run_retry_script
  tags: ["patch-run"]
  commands:
    - func: run_retry_script

- name: e2e_multiple_cluster_failures
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_standalone_custom_podspec
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_schema_validation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_schema_validation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_schema_validation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_users_schema_validation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_crd_validation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_config_map
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_groups
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_recovery
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_operator_partial_crd
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_operator_clusterwide
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_operator_multi_namespaces
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_operator_upgrade_replica_set
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_operator_upgrade_ops_manager
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_operator_upgrade_appdb_tls
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_olm_operator_upgrade
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_olm_operator_webhooks
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_olm_operator_upgrade_with_resources
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_backup_delete_sts_and_log_rotation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_backup_kmip
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_liveness_probe
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_mongodb_validation_webhook
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_mongodb_roles_validation_webhook
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_recovery
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_config_map
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_groups
  tags: ["patch-run"]
  commands:
     - func: "e2e_test"

- name: e2e_replica_set_pv
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_pv_multiple
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_exposed_externally
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_readiness_probe
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_migration
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replication_state_awareness
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_statefulset_status
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_update_delete_parallel
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_sc_additional_certs
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_sharded_cluster_certs_prefix
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_migration
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_rs_additional_certs
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_rs_intermediate_ca
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_rs_external_access
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"


- name: e2e_sharded_cluster
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_pv
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_recovery
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_secret
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_scale_shards
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_statefulset_status
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_agent_flags
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_agent_flags
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_agent_flags_and_readinessProbe
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_type_change_recovery
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_all_mongodb_resources_parallel
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_upgrade_downgrade
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_upgrade_downgrade
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_custom_podspec
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_custom_sa
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_report_pending_pods
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_mongod_options
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_mongod_options_and_log_rotation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_custom_podspec
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_upgrade_downgrade
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_standalone_no_tls_no_status_is_set
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_default
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_override
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"


- name: e2e_replica_set_ignore_unknown_users
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_process_hostnames
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_process_hostnames
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_member_options
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_tls_allow
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_prefer
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_require
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_certs_secret_prefix
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_sharded_cluster_tls_certs_top_level_prefix
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_disable_tls_scale_up
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_require_to_allow
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_tls_require_custom_ca
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_require_and_disable
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_tls_multiple_different_ssl_configs
  commands:
  - func: "e2e_test"

- name: e2e_replica_set_tls_require_upgrade
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_tls_x509_rs
  tags: ["patch-run"]
  # longer timeout than usual as this test tests recovery from bad states which can take some time
  commands:
  - func: "e2e_test"

- name: e2e_tls_x509_sc
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_x509_users_addition_removal
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_x509_user_connectivity
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_x509_configure_all_options_rs
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_tls_x509_configure_all_options_sc
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_scram_sha_256_user_connectivity
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_scram_sha_256_user_first
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_scram_sha_1_user_connectivity
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_scram_sha_256_user_connectivity
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_scram_sha_1_user_connectivity
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_scram_sha_1_upgrade
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_scram_sha_1_upgrade
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_x509_to_scram_transition
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_x509_to_scram_transition
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_internal_cluster_transition
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_ldap
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_ldap
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_ldap_tls
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_ldap_user_to_dn_mapping
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_ldap_agent_auth
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_ldap_agent_client_certs
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_custom_roles
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_update_roles_no_privileges
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_ldap_group_dn
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_ldap_group_dn_with_x509_agent
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_feature_controls_authentication
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_scram_sha_and_x509
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_scram_sha_and_x509
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_scram_x509_internal_cluster
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_replica_set_scram_x509_ic_manual_certs
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_scram_x509_ic_manual_certs
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_sharded_cluster_scram_x509_internal_cluster
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_configure_tls_and_x509_simultaneously_rs
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_configure_tls_and_x509_simultaneously_sc
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_configure_tls_and_x509_simultaneously_st
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

# E2E tests for Ops Manager (sorted alphabetically):
- name: e2e_om_appdb_flags_and_config
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_appdb_monitoring_tls
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_appdb_multi_change
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_appdb_scale_up_down
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_appdb_scram
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_appdb_upgrade
  tags: ["patch-run"]
  commands:
  - func: "e2e_test"

- name: e2e_om_appdb_validation
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_external_connectivity
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_weak_password
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_multiple
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_backup
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_backup_sharded_cluster
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_backup_liveness_probe
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_backup_light
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_backup_tls
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_backup_s3_tls
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_backup_tls_custom_ca
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_backup_restore
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_queryable_backup
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_feature_controls
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_scale
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_upgrade
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_prometheus
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_pod_spec
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_validation_webhook
  tags: ["patch-run"]
  commands:
    - func: "e2e_test"

- name: e2e_om_ops_manager_https_enabled
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_https_enabled_hybrid
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_https_enabled_prefix
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_https_enabled_internet_mode
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_jvm_params
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_migration
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_localmode
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_enable_local_mode_running_om
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_remotemode
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_localmode_multiple_pv
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_secure_config
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_replica_set
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_replica_set_migration
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_replica_set_member_options
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_replica_set_scale_up
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_scale_up_cluster
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_scale_up_cluster_new_cluster
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_scale_down_cluster
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_replica_set_scale_down
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_replica_set_deletion
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_mtls_test
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_scram
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_sts_override
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_tls_with_scram
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_enable_tls
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_upgrade_downgrade
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_tls_cert_rotation
  tags: ["patch-run"]
  commands:
    - func: e2e_test


- name: e2e_multi_cluster_tls_no_mesh
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_backup_restore
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_appdb_s3_based_backup_restore
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_backup_restore_no_mesh
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_appdb_validation
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_om_validation
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_appdb
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_tls_with_x509
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_with_ldap
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_with_ldap_custom_roles
  tags: ["patch-run"]
  commands:
    - func: e2e_test


- name: e2e_multi_cluster_specific_namespaces
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_clusterwide
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_disaster_recovery
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_multi_disaster_recovery
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_2_clusters_replica_set
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_2_clusters_clusterwide
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_recover
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_recover_network_partition
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_recover_clusterwide
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_agent_flags
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_replica_set_ignore_unknown_users
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_validation
  tags: ["patch-run"]
  exec_timeout_secs: 1000
  commands:
    - func: e2e_test

- name: e2e_om_update_before_reconciliation
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_vault_setup
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_vault_setup_tls
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_vault_setup_om
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_vault_setup_om_backup
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_ops_manager_backup_restore_minio
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_appdb_disaster_recovery
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_appdb_disaster_recovery_force_reconfigure
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_om_networking_clusterwide
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_multi_cluster_om_clusterwide_operator_not_in_mesh_networking
  tags: ["patch-run"]
  commands:
    - func: e2e_test

# this test is run, with an operator with race enabled
- name: e2e_om_reconcile_race
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: e2e_om_reconcile_perf
  tags: ["patch-run"]
  commands:
    - func: e2e_test

- name: generate_perf_tasks_one_thread
  patch_only: true
  commands:
    - func: clone
    - func: generate_perf_tests_tasks
      vars:
        variant: e2e_operator_perf_one_thread
        size: small

- name: generate_perf_tasks_10_thread
  patch_only: true
  commands:
    - func: clone
    - func: generate_perf_tests_tasks
      vars:
        variant: e2e_operator_perf
        size: small

- name: generate_perf_tasks_30_thread
  patch_only: true
  commands:
    - func: clone
    - func: generate_perf_tests_tasks
      vars:
        variant: e2e_operator_perf_thirty
        size: small

- name: release_database
  tags: ["image_release"]
  git_tag_only: true
  commands:
  - func: clone
  - func: setup_building_host
  - func: quay_login
  - func: setup_docker_sbom
  - func: pipeline
    vars:
      image_name: database

- name: build_om_images
  commands:
  - func: clone
  - func: setup_building_host
  - func: pipeline
    vars:
      image_name: ops-manager
      skip_tags: release

- name: publish_ops_manager
  patch_only: true
  commands:
  - func: clone
  - func: setup_building_host
  - func: quay_login
  - func: setup_docker_sbom
  - func: pipeline
    vars:
      image_name: ops-manager
      include_tags: release

- name: prepare_and_upload_openshift_bundles_for_e2e
  commands:
    - func: clone
    - func: setup_building_host
    - func: configure_docker_auth
    - func: download_kube_tools
    - func: setup_prepare_openshift_bundles
    - func: prepare_openshift_bundles_for_e2e

task_groups:
- name: unit_task_group
  setup_group:
    - func: clone
    - func: download_kube_tools
    - func: setup_shellcheck
  tasks:
    - lint_repo
    - unit_tests
    - sbom_tests

# This is the task group that contains all the tests run in the e2e_mdb_kind_ubuntu_cloudqa build variant
- name: e2e_mdb_kind_cloudqa_task_group
  max_hosts: 30
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    # e2e_kube_only_task_group
    - e2e_crd_validation
    - e2e_replica_set_config_map
    - e2e_replica_set_exposed_externally
    - e2e_replica_set_pv
    - e2e_replica_set_pv_multiple
    - e2e_replica_set_schema_validation
    - e2e_replica_set_statefulset_status
    - e2e_sharded_cluster_pv
    - e2e_sharded_cluster_recovery
    - e2e_sharded_cluster_schema_validation
    - e2e_sharded_cluster_statefulset_status
    - e2e_standalone_config_map
    - e2e_standalone_recovery
    - e2e_standalone_schema_validation
    - e2e_users_schema_validation
    - e2e_replica_set_tls_default
    - e2e_replica_set_tls_override
    - e2e_replica_set_ignore_unknown_users
    # e2e_core_task_group
    - e2e_all_mongodb_resources_parallel
    - e2e_multiple_cluster_failures
    - e2e_replica_set_custom_podspec
    - e2e_replica_set_custom_sa
    - e2e_replica_set_report_pending_pods
    - e2e_replica_set_recovery
    - e2e_replica_set_upgrade_downgrade
    - e2e_replica_set_agent_flags_and_readinessProbe
    - e2e_sharded_cluster
    - e2e_sharded_cluster_secret
    - e2e_sharded_cluster_upgrade_downgrade
    - e2e_sharded_cluster_custom_podspec
    - e2e_sharded_cluster_agent_flags
    - e2e_standalone_type_change_recovery
    - e2e_standalone_upgrade_downgrade
    - e2e_standalone_custom_podspec
    - e2e_standalone_agent_flags
    - e2e_replica_set_process_hostnames
    - e2e_replica_set_member_options
    # e2e_tls_task_group
    - e2e_replica_set_tls_allow
    - e2e_replica_set_tls_prefer
    - e2e_replica_set_tls_require_upgrade
    - e2e_tls_rs_additional_certs
    - e2e_tls_sc_additional_certs
    - e2e_tls_rs_intermediate_ca
    - e2e_tls_sharded_cluster_certs_prefix
    - e2e_sharded_cluster_migration
    - e2e_standalone_no_tls_no_status_is_set
    - e2e_feature_controls_authentication
    - e2e_replica_set
    - e2e_replica_set_liveness_probe
    - e2e_replica_set_mongod_options
    - e2e_replica_set_readiness_probe
    - e2e_replica_set_update_delete_parallel
    - e2e_sharded_cluster_scale_shards
    - e2e_sharded_cluster_mongod_options_and_log_rotation
    - e2e_tls_rs_external_access
    - e2e_replica_set_tls_require
    - e2e_replica_set_tls_certs_secret_prefix
    - e2e_sharded_cluster_tls_certs_top_level_prefix
    - e2e_disable_tls_scale_up
    - e2e_replica_set_tls_require_and_disable
    # e2e_x509_task_group
    - e2e_configure_tls_and_x509_simultaneously_st
    - e2e_configure_tls_and_x509_simultaneously_rs
    - e2e_configure_tls_and_x509_simultaneously_sc
    - e2e_tls_x509_rs
    - e2e_tls_x509_sc
    - e2e_tls_x509_configure_all_options_rs
    - e2e_tls_x509_configure_all_options_sc
    - e2e_tls_x509_user_connectivity
    - e2e_tls_x509_users_addition_removal
    - e2e_replica_set_tls_process_hostnames
    # e2e_ldap_task_group
    - e2e_replica_set_ldap
    - e2e_sharded_cluster_ldap
    - e2e_replica_set_ldap_tls
    - e2e_replica_set_ldap_user_to_dn_mapping
    - e2e_replica_set_ldap_agent_auth
    - e2e_replica_set_ldap_agent_client_certs
    - e2e_replica_set_custom_roles
    - e2e_replica_set_update_roles_no_privileges
    - e2e_replica_set_ldap_group_dn
    - e2e_replica_set_ldap_group_dn_with_x509_agent
    # e2e_scram_sha_task_group_with_manually_generated_certs
    - e2e_replica_set_scram_sha_256_user_connectivity
    - e2e_replica_set_scram_sha_256_user_first
    - e2e_replica_set_scram_sha_1_user_connectivity
    - e2e_replica_set_scram_sha_1_upgrade
    - e2e_replica_set_scram_x509_ic_manual_certs
    - e2e_sharded_cluster_scram_sha_1_upgrade
    - e2e_sharded_cluster_scram_sha_256_user_connectivity
    - e2e_sharded_cluster_scram_sha_1_user_connectivity
    - e2e_sharded_cluster_scram_x509_ic_manual_certs
    # e2e_auth_transitions_task_group
    - e2e_replica_set_scram_sha_and_x509
    - e2e_replica_set_x509_to_scram_transition
    - e2e_sharded_cluster_scram_sha_and_x509
    - e2e_sharded_cluster_x509_to_scram_transition
    - e2e_sharded_cluster_internal_cluster_transition
    # e2e_webhook_validation_task_group
    - e2e_mongodb_validation_webhook
    - e2e_mongodb_roles_validation_webhook
    - e2e_vault_setup
    - e2e_vault_setup_tls
    # this test will either migrate from static to non-static or the other way around
    - e2e_replica_set_migration
  <<: *teardown_group

# this task group contains just a one task, which is smoke testing whether the operator
# works correctly when we run it without installing webhook cluster roles
- name: e2e_mdb_kind_no_webhook_roles_cloudqa_task_group
  max_hosts: 30
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_replica_set_agent_flags_and_readinessProbe
  <<: *teardown_group

# This task group mostly duplicates tests running in e2e_mdb_kind_ubi_cloudqa
# This is mostly a smoke test, so we execute only a few essential ones.
- name: e2e_mdb_openshift_ubi_cloudqa_task_group
  # OM tests are also run on the same Openshift cluster, so we use 1 max host to not
  # allow the helm installations to interfere with eachother during the setup of the tests.
  max_hosts: 1
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_crd_validation
    - e2e_replica_set_scram_sha_256_user_connectivity
    - e2e_sharded_cluster_scram_sha_256_user_connectivity
    - e2e_replica_set_pv
    - e2e_sharded_cluster_pv

- name: e2e_custom_domain_task_group
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_replica_set

# e2e_operator_task_group includes the tests for the specific Operator configuration/behavior. They may deal with
# cluster-wide resources so should be run in isolated K8s clusters only (Kind or Minikube).
- name: e2e_operator_task_group
  max_hosts: -1
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_operator_upgrade_replica_set
    - e2e_operator_upgrade_ops_manager
    - e2e_operator_partial_crd
    - e2e_operator_clusterwide
    - e2e_operator_multi_namespaces
    - e2e_operator_upgrade_appdb_tls
  <<: *teardown_group

# e2e_operator_race_task_group includes the tests for testing the operator with race detector enabled
- name: e2e_operator_race_task_group
  max_hosts: 30
  <<: *setup_group_multi_cluster
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_om_reconcile_race
  <<: *teardown_group

# e2e_operator_task_group includes the tests for the specific Operator configuration/behavior. They may deal with
# cluster-wide resources so should be run in isolated K8s clusters only (Kind or Minikube).
- name: e2e_static_operator_task_group
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_operator_upgrade_replica_set
    - e2e_operator_upgrade_ops_manager
    - e2e_operator_partial_crd
    - e2e_operator_clusterwide
    - e2e_operator_multi_namespaces
    - e2e_operator_upgrade_appdb_tls
  <<: *teardown_group

- name: e2e_multi_cluster_kind_task_group
  max_hosts: 10
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_multi_cluster_replica_set
    - e2e_multi_cluster_replica_set_migration
    - e2e_multi_cluster_replica_set_member_options
    - e2e_multi_cluster_recover
    - e2e_multi_cluster_recover_clusterwide
    - e2e_multi_cluster_specific_namespaces
    - e2e_multi_cluster_scram
    - e2e_multi_cluster_tls_with_x509
    - e2e_multi_cluster_tls_no_mesh
    - e2e_multi_cluster_enable_tls
    - e2e_multi_cluster_with_ldap
    - e2e_multi_cluster_with_ldap_custom_roles
    - e2e_multi_cluster_mtls_test
    - e2e_multi_cluster_replica_set_deletion
    - e2e_multi_cluster_replica_set_scale_up
    - e2e_multi_cluster_scale_up_cluster
    - e2e_multi_cluster_scale_up_cluster_new_cluster
    - e2e_multi_cluster_replica_set_scale_down
    - e2e_multi_cluster_scale_down_cluster
    - e2e_multi_sts_override
    - e2e_multi_cluster_tls_with_scram
    - e2e_multi_cluster_upgrade_downgrade
    - e2e_multi_cluster_backup_restore
    - e2e_multi_cluster_backup_restore_no_mesh
    - e2e_multi_cluster_disaster_recovery
    - e2e_multi_cluster_multi_disaster_recovery
    - e2e_multi_cluster_recover_network_partition
    - e2e_multi_cluster_validation
    - e2e_multi_cluster_agent_flags
    - e2e_multi_cluster_replica_set_ignore_unknown_users
  <<: *teardown_group

- name: e2e_multi_cluster_2_clusters_task_group
  max_hosts: 2
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_multi_cluster_2_clusters_replica_set
    - e2e_multi_cluster_2_clusters_clusterwide
  <<: *teardown_group

- name: e2e_multi_cluster_om_appdb_task_group
  max_hosts: 30
  <<: *setup_group_multi_cluster
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    # Dedicated AppDB Multi-Cluster tests
    - e2e_multi_cluster_appdb_validation
    - e2e_multi_cluster_om_validation
    - e2e_multi_cluster_appdb
    - e2e_multi_cluster_appdb_s3_based_backup_restore
    - e2e_multi_cluster_appdb_disaster_recovery
    - e2e_multi_cluster_appdb_disaster_recovery_force_reconfigure
    - e2e_multi_cluster_om_networking_clusterwide
    # Reused OM tests with AppDB Multi-Cluster topology
    - e2e_om_appdb_flags_and_config
    - e2e_om_appdb_upgrade
    - e2e_om_appdb_monitoring_tls
    - e2e_om_ops_manager_backup
    - e2e_om_ops_manager_backup_light
    - e2e_om_ops_manager_backup_liveness_probe
    - e2e_om_ops_manager_pod_spec
    - e2e_om_ops_manager_secure_config
    - e2e_om_appdb_validation
    - e2e_om_appdb_scram
    - e2e_om_external_connectivity
    - e2e_om_jvm_params
    - e2e_om_migration
    - e2e_om_localmode
    - e2e_om_ops_manager_enable_local_mode_running_om
    - e2e_om_localmode_multiple_pv
    - e2e_om_weak_password
    - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
    - e2e_om_ops_manager_backup_tls
    - e2e_om_ops_manager_backup_s3_tls
    - e2e_om_ops_manager_backup_tls_custom_ca
    - e2e_om_ops_manager_backup_sharded_cluster
    - e2e_om_ops_manager_backup_kmip
    - e2e_om_ops_manager_https_enabled
    - e2e_om_ops_manager_https_enabled_hybrid
    - e2e_om_ops_manager_https_enabled_internet_mode
    - e2e_om_ops_manager_https_enabled_prefix
    - e2e_om_ops_manager_scale
    - e2e_om_ops_manager_upgrade
    - e2e_om_update_before_reconciliation
    - e2e_om_feature_controls
# disabled tests:
#    - e2e_om_multiple # multi-cluster failures in EVG
#    - e2e_om_appdb_scale_up_down # test not "reused" for multi-cluster appdb
  <<: *teardown_group

- name: e2e_static_multi_cluster_om_appdb_task_group
  max_hosts: 30
  <<: *setup_group_multi_cluster
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    # Dedicated AppDB Multi-Cluster tests
    - e2e_multi_cluster_appdb_validation
    - e2e_multi_cluster_om_validation
    - e2e_multi_cluster_appdb
    - e2e_multi_cluster_appdb_s3_based_backup_restore
    - e2e_multi_cluster_appdb_disaster_recovery
    - e2e_multi_cluster_appdb_disaster_recovery_force_reconfigure
    - e2e_multi_cluster_om_networking_clusterwide
    # Reused OM tests with AppDB Multi-Cluster topology
    - e2e_om_appdb_flags_and_config
    - e2e_om_appdb_upgrade
    - e2e_om_appdb_monitoring_tls
    - e2e_om_ops_manager_backup
    - e2e_om_ops_manager_backup_light
    - e2e_om_ops_manager_backup_liveness_probe
    - e2e_om_ops_manager_pod_spec
    - e2e_om_ops_manager_secure_config
    - e2e_om_appdb_validation
    - e2e_om_appdb_scram
    - e2e_om_external_connectivity
    - e2e_om_jvm_params
    - e2e_om_migration
#  Deactivated tests
#    - e2e_om_localmode
#    - e2e_om_localmode_multiple_pv
#    - e2e_om_ops_manager_https_enabled
#    - e2e_om_ops_manager_https_enabled_hybrid
#    - e2e_om_ops_manager_https_enabled_internet_mode
    - e2e_om_ops_manager_https_enabled_prefix
    - e2e_om_ops_manager_enable_local_mode_running_om
    - e2e_om_weak_password
    - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
    - e2e_om_ops_manager_backup_tls
    - e2e_om_ops_manager_backup_s3_tls
    - e2e_om_ops_manager_backup_tls_custom_ca
    - e2e_om_ops_manager_backup_sharded_cluster
    - e2e_om_ops_manager_backup_kmip
    - e2e_om_ops_manager_scale
    - e2e_om_ops_manager_upgrade
    - e2e_om_update_before_reconciliation
    - e2e_om_feature_controls
  <<: *teardown_group

# Dedicated task group for deploying OM Multi-Cluster when the operator is in the central cluster
# that is not in the mesh
- name: e2e_multi_cluster_om_operator_not_in_mesh_task_group
  max_hosts: 30
  <<: *setup_group_multi_cluster
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_multi_cluster_om_clusterwide_operator_not_in_mesh_networking
  <<: *teardown_group


# This task group runs on Kind clusters. In theory ALL Ops Manager tests should be added here
# including the cluster-wide resources changing. Uses Cloud-qa.
- name: e2e_ops_manager_kind_only_task_group
  max_hosts: 15
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_om_appdb_flags_and_config
    - e2e_om_appdb_monitoring_tls
    - e2e_om_appdb_multi_change
    - e2e_om_appdb_scale_up_down
    - e2e_om_appdb_upgrade
    - e2e_om_appdb_validation
    - e2e_om_appdb_scram
    - e2e_om_external_connectivity
    - e2e_om_jvm_params
    - e2e_om_migration
    - e2e_om_localmode
    - e2e_om_ops_manager_enable_local_mode_running_om
    - e2e_om_localmode_multiple_pv
    - e2e_om_weak_password
    - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
    - e2e_om_ops_manager_backup_light
    - e2e_om_ops_manager_backup_tls
    - e2e_om_ops_manager_backup_s3_tls
    - e2e_om_ops_manager_backup_restore_minio
    - e2e_om_ops_manager_backup_tls_custom_ca
    - e2e_om_ops_manager_backup_liveness_probe
    - e2e_om_ops_manager_backup_sharded_cluster
    - e2e_om_ops_manager_backup_kmip
    - e2e_om_ops_manager_pod_spec
    - e2e_om_ops_manager_https_enabled
    - e2e_om_ops_manager_https_enabled_hybrid
    - e2e_om_ops_manager_https_enabled_internet_mode
    - e2e_om_ops_manager_https_enabled_prefix
    - e2e_om_ops_manager_scale
    - e2e_om_ops_manager_upgrade
    - e2e_om_validation_webhook
    - e2e_om_ops_manager_secure_config
    - e2e_om_update_before_reconciliation
    - e2e_om_multiple
    - e2e_om_feature_controls
    - e2e_vault_setup_om
    - e2e_vault_setup_om_backup
  <<: *teardown_group

- name: e2e_static_ops_manager_kind_only_task_group
  max_hosts: 15
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_om_appdb_flags_and_config
    - e2e_om_appdb_monitoring_tls
    - e2e_om_appdb_multi_change
    - e2e_om_appdb_scale_up_down
    - e2e_om_appdb_upgrade
    - e2e_om_appdb_validation
    - e2e_om_appdb_scram
    - e2e_om_external_connectivity
    - e2e_om_jvm_params
    - e2e_om_weak_password
    - e2e_om_ops_manager_backup_delete_sts_and_log_rotation
    - e2e_om_ops_manager_backup_light
    - e2e_om_ops_manager_backup_tls
    - e2e_om_ops_manager_backup_s3_tls
    - e2e_om_ops_manager_backup_restore_minio
    - e2e_om_ops_manager_backup_tls_custom_ca
    - e2e_om_ops_manager_backup_liveness_probe
    - e2e_om_ops_manager_backup_sharded_cluster
    - e2e_om_ops_manager_backup_kmip
    - e2e_om_ops_manager_pod_spec
    - e2e_om_ops_manager_scale
    - e2e_om_ops_manager_upgrade
    - e2e_om_validation_webhook
    - e2e_om_ops_manager_secure_config
    - e2e_om_update_before_reconciliation
    - e2e_om_multiple
    - e2e_om_feature_controls
    - e2e_vault_setup_om
    - e2e_vault_setup_om_backup
#   Deactivated tests
#    - e2e_om_localmode_multiple_pv
#    - e2e_om_localmode
#    - e2e_om_ops_manager_https_enabled_hybrid
#    - e2e_om_ops_manager_https_enabled_internet_mode
#    - e2e_om_ops_manager_https_enabled
#    - e2e_om_ops_manager_https_enabled_prefix
  <<: *teardown_group

- name: e2e_smoke_task_group
  max_hosts: 1
  <<: *setup_group
  <<: *setup_and_teardown_task_cloudqa
  tasks:
    - e2e_om_ops_manager_backup
  <<: *teardown_group

- name: e2e_ops_manager_kind_5_0_only_task_group
  max_hosts: 3
  <<: *setup_group
  <<: *setup_and_teardown_task
  tasks:
    - e2e_om_remotemode
    - e2e_om_ops_manager_backup_restore
    - e2e_om_ops_manager_queryable_backup
    - e2e_om_ops_manager_backup
  <<: *teardown_group


# Tests features only supported on OM60
- name: e2e_ops_manager_kind_6_0_only_task_group
  max_hosts: 3
  <<: *setup_group
  <<: *setup_and_teardown_task
  tasks:
    - e2e_om_ops_manager_prometheus
  <<: *teardown_group

# Tests features only supported on OM60
- name: e2e_static_ops_manager_kind_6_0_only_task_group
  max_hosts: 3
  <<: *setup_group
  <<: *setup_and_teardown_task
  tasks:
    - e2e_om_ops_manager_prometheus
  <<: *teardown_group

- name: e2e_kind_olm_group
  max_hosts: 30
  <<: *setup_group
  <<: *setup_and_teardown_task
  setup_task:
    # Even if the two first tasks are already part of setup_and_teardown_task,
    # we need to repeat them because we are overriding the setup_task variable of the YAML anchor
    - func: cleanup_exec_environment
    - func: setup_kubernetes_environment
    - func: setup_prepare_openshift_bundles
    - func: install_olm
  tasks:
    - e2e_olm_operator_upgrade
    - e2e_olm_operator_upgrade_with_resources
  <<: *teardown_group

buildvariants:

## Build variants for E2E tests

# The pattern for naming build variants for E2E tests:
# e2e_<type>_<cluster>_<distro>[<om_version>]
# where <type> is any of mdb|om<version>|operator
# where <cluster> is any of kind|openshift
# where <distro> is any of ubuntu|ubi
# where <om_version> denotes the OM version tested (e.g. om50, om60, cloudqa) - used only for MDB tests

## MongoDB build variants
- name: e2e_mdb_kind_ubi_cloudqa
  display_name: e2e_mdb_kind_ubi_cloudqa
  run_on:
    - ubuntu2204-large
  <<: *base_no_om_image_dependency
  tasks:
    - name: e2e_mdb_kind_cloudqa_task_group

- name: e2e_custom_domain_mdb_kind_ubi_cloudqa
  display_name: e2e_custom_domain_mdb_kind_ubi_cloudqa
  run_on:
    - ubuntu2204-large
  <<: *base_no_om_image_dependency
  tasks:
    - name: e2e_custom_domain_task_group

- name: e2e_static_mdb_kind_ubi_cloudqa
  display_name: e2e_static_mdb_kind_ubi_cloudqa
  run_on:
    - ubuntu2204-large
  <<: *base_no_om_image_dependency
  tasks:
    - name: e2e_mdb_kind_cloudqa_task_group

- name: e2e_static_custom_domain_mdb_kind_ubi_cloudqa
  display_name: e2e_static_custom_domain_mdb_kind_ubi_cloudqa
  run_on:
    - ubuntu2204-large
  depends_on:
    - name: build_operator_ubi
      variant: init_test_run
    - name: build_test_image
      variant: init_test_run
    - name: build_init_appdb_images_ubi
      variant: init_test_run
    - name: build_init_om_images_ubi
      variant: init_test_run
    - name: build_init_database_image_ubi
      variant: init_test_run
    - name: build_agent_images_ubi
      variant: init_test_run
  tasks:
    - name: e2e_custom_domain_task_group

- name: e2e_mdb_openshift_ubi_cloudqa
  display_name: e2e_mdb_openshift_ubi_cloudqa
  depends_on:
    - name: build_operator_ubi
      variant: init_test_run
    - name: build_init_database_image_ubi
      variant: init_test_run
    - name: build_database_image_ubi
      variant: init_test_run
    - name: build_test_image
      variant: init_test_run
  run_on:
  - ubuntu2204-small
  tasks:
  - name: e2e_mdb_openshift_ubi_cloudqa_task_group

# This name is on purpose reversed from e2e_static_openshift to e2e_openshift_static.
# That is because we run a regex
# in evergreen for all variants matching e2e_static-*, but we do not want to run openshift variants on every pr.
- name: e2e_openshift_static_mdb_ubi_cloudqa
  display_name: e2e_openshift_static_mdb_ubi_cloudqa
  depends_on:
    - name: build_operator_ubi
      variant: init_test_run
    - name: build_test_image
      variant: init_test_run
    - name: build_init_database_image_ubi
      variant: init_test_run
    - name: build_agent_images_ubi
      variant: init_test_run
  run_on:
  - ubuntu2204-small
  tasks:
  - name: e2e_mdb_openshift_ubi_cloudqa_task_group

## Ops Manager build variants

# Isolated Ops Manager Tests for 6.0 version
- name: e2e_om60_kind_ubi
  display_name: e2e_om60_kind_ubi
  run_on:
  - ubuntu2204-large
  <<: *base_om6_dependency
  tasks:
  - name: e2e_ops_manager_kind_only_task_group
  - name: e2e_ops_manager_kind_5_0_only_task_group
  - name: e2e_ops_manager_kind_6_0_only_task_group

# Isolated Ops Manager Tests for 6.0 version
- name: e2e_static_om60_kind_ubi
  display_name: e2e_static_om60_kind_ubi
  run_on:
  - ubuntu2204-large
  <<: *base_om6_dependency
  tasks:
  - name: e2e_static_ops_manager_kind_only_task_group
  - name: e2e_static_ops_manager_kind_6_0_only_task_group

# Isolated Ops Manager Tests for 7.0 version
- name: e2e_om70_kind_ubi
  display_name: e2e_om70_kind_ubi
  run_on:
  - ubuntu2204-large
  <<: *base_om7_dependency
  tasks:
  - name: e2e_ops_manager_kind_only_task_group
  - name: e2e_ops_manager_kind_5_0_only_task_group
  - name: e2e_ops_manager_kind_6_0_only_task_group

- name: e2e_operator_race_ubi
  display_name: e2e_operator_race_ubi
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om7_dependency
  tasks:
    - name: e2e_operator_race_task_group

# Isolated Ops Manager Tests for 7.0 version
- name: e2e_static_om70_kind_ubi
  display_name: e2e_static_om70_kind_ubi
  run_on:
  - ubuntu2204-large
  <<: *base_om7_dependency
  tasks:
    - name: e2e_static_ops_manager_kind_only_task_group
    - name: e2e_static_ops_manager_kind_6_0_only_task_group

- name: e2e_smoke
  display_name: e2e_smoke
  run_on:
    - ubuntu2204-large
  depends_on:
    - name: build_test_image
      variant: init_test_run
  tasks:
    - name: e2e_smoke_task_group

- name: e2e_smoke_release
  display_name: e2e_smoke_release
  run_on:
    - ubuntu2204-large
  git_tag_only: true
  depends_on:
    - name: build_test_image
      variant: init_test_run
    - name: ".image_release"
      variant: release
  tasks:
    - name: e2e_smoke_task_group

- name: e2e_static_smoke_release
  display_name: e2e_static_smoke_release
  run_on:
    - ubuntu2204-large
  git_tag_only: true
  depends_on:
    - name: build_test_image
      variant: init_test_run
    - name: ".image_release"
      variant: release
  tasks:
    - name: e2e_smoke_task_group

- name: e2e_static_smoke
  display_name: e2e_static_smoke
  run_on:
    - ubuntu2204-large
  depends_on:
    - name: build_test_image
      variant: init_test_run
  tasks:
    - name: e2e_smoke_task_group

- name: e2e_multi_cluster_kind
  display_name: e2e_multi_cluster_kind
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om6_dependency
  tasks:
    - name: e2e_multi_cluster_kind_task_group

- name: e2e_static_multi_cluster_kind
  display_name: e2e_static_multi_cluster_kind
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om6_dependency
  tasks:
    - name: e2e_multi_cluster_kind_task_group

- name: e2e_multi_cluster_2_clusters
  display_name: e2e_multi_cluster_2_clusters
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om6_dependency
  tasks:
    - name: e2e_multi_cluster_2_clusters_task_group

- name: e2e_static_multi_cluster_2_clusters
  display_name: e2e_static_multi_cluster_2_clusters
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om6_dependency
  tasks:
    - name: e2e_multi_cluster_2_clusters_task_group

- name: e2e_multi_cluster_om_appdb
  display_name: e2e_multi_cluster_om_appdb
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om6_dependency
  tasks:
    - name: e2e_multi_cluster_om_appdb_task_group

- name: e2e_static_multi_cluster_om_appdb
  display_name: e2e_static_multi_cluster_om_appdb
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om6_dependency
  tasks:
    - name: e2e_static_multi_cluster_om_appdb_task_group

- name: e2e_multi_cluster_om_operator_not_in_mesh
  display_name: e2e_multi_cluster_om_operator_not_in_mesh
  run_on:
    -  ubuntu1804-xlarge
  <<: *base_om7_dependency
  tasks:
    - name: e2e_multi_cluster_om_operator_not_in_mesh_task_group


## Operator tests build variants

- name: e2e_operator_kind_ubi_cloudqa
  display_name: e2e_operator_kind_ubi_cloudqa
  run_on:
    - ubuntu2204-large
  <<: *base_no_om_image_dependency
  tasks:
    - name: e2e_operator_task_group

- name: e2e_static_operator_kind_ubi_cloudqa
  display_name: e2e_static_operator_kind_ubi_cloudqa
  run_on:
    - ubuntu2204-large
  <<: *base_no_om_image_dependency
  tasks:
    - name: e2e_static_operator_task_group

- name: e2e_operator_no_webhook_roles_cloudqa
  display_name: e2e_operator_no_webhook_roles_cloudqa
  run_on:
    - ubuntu2204-large
  <<: *base_no_om_image_dependency
  tasks:
    - name: e2e_mdb_kind_no_webhook_roles_cloudqa_task_group

- name: e2e_kind_olm_ubi
  display_name: e2e_kind_olm_ubi
  run_on:
    - ubuntu2204-large
  depends_on:
    - name: build_om_images
      variant: build_om60_images
    - name: build_operator_ubi
      variant: init_test_run
    - name: build_test_image
      variant: init_test_run
    - name: build_init_om_images_ubi
      variant: init_test_run
    - name: build_init_database_image_ubi
      variant: init_test_run
    - name: build_database_image_ubi
      variant: init_test_run
    - name: build_init_appdb_images_ubi
      variant: init_test_run
    - name: prepare_and_upload_openshift_bundles_for_e2e
      variant: init_tests_with_olm
  tasks:
    - name: e2e_kind_olm_group

- name: e2e_static_kind_olm_ubi
  display_name: e2e_static_kind_olm_ubi
  run_on:
    - ubuntu2204-large
  depends_on:
    - name: build_om_images
      variant: build_om60_images
    - name: build_operator_ubi
      variant: init_test_run
    - name: build_test_image
      variant: init_test_run
    - name: build_init_om_images_ubi
      variant: init_test_run
    - name: build_init_appdb_images_ubi
      variant: init_test_run
    - name: prepare_and_upload_openshift_bundles_for_e2e
      variant: init_tests_with_olm
    - name: build_init_database_image_ubi
      variant: init_test_run
    - name: build_agent_images_ubi
      variant: init_test_run
  tasks:
    - name: e2e_kind_olm_group

### End of build variants for E2E

### Release build variants

## Adds versions as supported in the supported versions Database.
## The responsibility of actually building this image/version and pushing them
## to public Docker repositories is of the periodic-build task.
- name: release
  display_name: release
  depends_on:
    - name: build_operator_ubi
      variant: init_test_run
    - name: build_init_om_images_ubi
      variant: init_test_run
    - name: build_init_appdb_images_ubi
      variant: init_test_run
    - name: build_init_database_image_ubi
      variant: init_test_run
    - name: build_database_image_ubi
      variant: init_test_run
  run_on:
    - ubuntu2204-large
  tasks:
    - name: release_operator
    - name: release_init_appdb
    - name: release_init_database
    - name: release_init_ops_manager
    - name: release_database
    - name: release_agent_operator_release

- name: preflight_release_images
  display_name: preflight_release_images
  run_on:
  - rhel90-small
  tasks:
    - name: preflight_release_images

- name: preflight_release_images_check
  display_name: preflight_release_images_check
  run_on:
    - rhel90-small
  tasks:
    - name: preflight_release_images

- name: upload_dockerfiles
  display_name: upload_dockerfiles
  run_on:
    - ubuntu2204-small
  tasks:
    - name: upload_dockerfiles

- name: init_test_run
  display_name: init_test_run
  run_on:
    - ubuntu2204-small
  tasks:
    - name: build_operator_ubi
    - name: build_test_image
    - name: build_init_appdb_images_ubi
    - name: build_init_om_images_ubi
    - name: build_init_database_image_ubi
    - name: build_database_image_ubi
    - name: build_agent_images_ubi
    - name: prepare_aws

- name: init_release_agents_on_ecr
  display_name: init_release_agents_on_ecr
  # We want that to run first and finish asap. Digest pinning depends on this to succeed.
  priority: 70
  run_on:
    - ubuntu2204-small
  tasks:
    - name: release_agents_on_ecr_conditional

- name: init_tests_with_olm
  display_name: init_tests_with_olm
  depends_on:
      - name: build_om_images
        variant: build_om60_images
      - name: build_operator_ubi
        variant: init_test_run
      - name: build_init_database_image_ubi
        variant: init_test_run
      - name: build_database_image_ubi
        variant: init_test_run
      - name: build_test_image
        variant: init_test_run
      - name: build_init_appdb_images_ubi
        variant: init_test_run
      - name: build_init_om_images_ubi
        variant: init_test_run
      - name: build_agent_images_ubi
        variant: init_test_run
      - name: release_agents_on_ecr_conditional
        variant: init_release_agents_on_ecr
  run_on:
    - ubuntu2204-small
  tasks:
    - name: prepare_and_upload_openshift_bundles_for_e2e

- name: go_unit_tests
  display_name: "go_unit_tests"
  run_on:
    - ubuntu2204-small
  tasks:
    - name: "unit_task_group"

### Build variants for manual patch only

- name: e2e_operator_perf
  display_name: e2e_operator_perf
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om7_dependency
  tasks:
    - name: generate_perf_tasks_10_thread

- name: e2e_operator_perf_one_thread
  display_name: e2e_operator_perf_one_thread
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om7_dependency
  tasks:
    - name: generate_perf_tasks_one_thread

- name: e2e_operator_perf_thirty
  display_name: e2e_operator_perf_thirty
  run_on:
    - ubuntu1804-xlarge
  <<: *base_om7_dependency
  tasks:
    - name: generate_perf_tasks_30_thread

- name: build_om60_images
  display_name: build_om60_images
  run_on:
  - ubuntu2204-small
  tasks:
  - name: build_om_images

- name: publish_om60_images
  display_name: publish_om60_images
  run_on:
    - ubuntu2204-large
  depends_on:
  - variant: e2e_om60_kind_ubi
    name: '*'
  - variant: e2e_static_om60_kind_ubi
    name: '*'
  tasks:
  - name: publish_ops_manager
  - name: release_agent

- name: preflight_om60_images
  display_name: preflight_om60_images
  run_on:
  - rhel90-small
  tasks:
  - name: preflight_om_image

- name: build_om70_images
  display_name: build_om70_images
  run_on:
    - ubuntu2204-small
  tasks:
    - name: build_om_images

- name: preflight_om70_images
  display_name: preflight_om70_images
  run_on:
  - rhel90-small
  tasks:
  - name: preflight_om_image

- name: publish_om70_images
  display_name: publish_om70_images
  run_on:
    - ubuntu2204-large
  depends_on:
    - variant: e2e_om70_kind_ubi
      name: '*'
    - variant: e2e_static_om70_kind_ubi
      name: '*'
  tasks:
    - name: publish_ops_manager
    - name: release_agent

# It will be called by pct while bumping the agent cloud manager image
- name: release_agent
  display_name: (Static Containers) Release Agent matrix
  run_on:
    - ubuntu2204-large
  depends_on:
    - variant: init_release_agents_on_ecr
      name: '*'
    - variant: e2e_multi_cluster_kind
      name: '*'
    - variant: e2e_static_multi_cluster_2_clusters
      name: '*'
    - variant: e2e_mdb_kind_ubi_cloudqa
      name: '*'
    - variant: e2e_static_mdb_kind_ubi_cloudqa
      name: '*'
  tasks:
    - name: release_agent

# Only called manually, It's used for testing the task release_agents_on_ecr in case the release.json
# has not changed, and you still want to push the images to ecr.
- name: manual_ecr_release_agent
  display_name: Manual Agent Release
  run_on:
    - ubuntu2204-large
  tasks:
    - name: release_agents_on_ecr
