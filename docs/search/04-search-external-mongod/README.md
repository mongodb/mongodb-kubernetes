# MongoDB Search with External MongoDB Enterprise (No TLS) - Quick Start

This guide shows how to deploy MongoDB Search in Kubernetes and connect it to an existing external MongoDB Enterprise
replica set
without TLS. The mongot component runs in the cluster, while the MongoDB Enterprise replica set exists externally.

## Prerequisites

Before you begin, ensure you have the following tools and configurations in place:

- **Kubernetes cluster**: A running Kubernetes cluster (e.g., Minikube, Kind, GKE, EKS, AKS) with kubeconfig available
  locally.
- **kubectl**: The Kubernetes command-line tool, configured to communicate with your cluster.
- **Helm**: The package manager for Kubernetes, used here to install the MongoDB Kubernetes Operator.
- **Bash 5.1+**: All shell commands in this guide are intended to be run in Bash. Scripts in this guide are
  automatically tested on Linux with Bash 5.1.
- **External MongoDB Enterprise**: An existing MongoDB Enterprise replica set (version 8.0.10 or higher) managed by Ops
  Manager that will serve as the data
  source for search.
- **Ops Manager**: Access to Ops Manager or MongoDB Cloud Manager with appropriate API credentials.

## Setup Steps

The following steps guide you through deploying MongoDB Search to connect to your external MongoDB Enterprise. Each step
provides a
shell script.
**It is important to first source the `env_variables.sh` script provided and customize its values for your environment.
**
The subsequent script snippets rely on the environment variables defined in `env_variables.sh`. You should copy and
paste each script into your Bash terminal.

### 1. Configure Environment Variables

First, you need to set up your environment. The `env_variables.sh` script, shown below, contains variables for the
subsequent steps. You should create this file locally or use the linked one.

Download or copy the content of `env_variables.sh`:
[env_variables.sh](env_variables.sh)

```shell copy
# set it to the context name of the k8s cluster
export K8S_CTX="<your kubernetes context here>"

# the following namespace will be created if not exists
export MDB_NS="mongodb"

# name of the MongoDB Custom Resource.
export MDB_RESOURCE_NAME="mdb-rs"

# OM/CM's project name to be used to manage mongodb replica set
export OPS_MANAGER_PROJECT_NAME="<arbitrary project name>"

# URL to Cloud Manager or Ops Manager instance
export OPS_MANAGER_API_URL="https://cloud-qa.mongodb.com"

# The API key can be an Org Owner - the operator can create the project automatically.
export OPS_MANAGER_API_USER="abcdefg"
export OPS_MANAGER_API_KEY="00000-abcd-efgh-1111-12345678"
export OPS_MANAGER_ORG_ID="62a73abcdefgh12345678"

# minimum required MongoDB version for running MongoDB Search is 8.0.10
export MDB_VERSION="8.0.10"

export MDB_ADMIN_USER_PASSWORD="admin-user-password-CHANGE-ME"
export MDB_USER_PASSWORD="mdb-user-password-CHANGE-ME"
export MDB_SEARCH_SYNC_USER_PASSWORD="search-sync-user-password-CHANGE-ME"

export MDB_SEARCH_HOSTNAME="mdbs-search"

# External MongoDB replica set members - REPLACE THESE VALUES with your actual external MongoDB hosts
# For testing purposes, these point to the MongoDB Enterprise resource created by test.sh
# In production, replace with your actual external MongoDB replica set members
export MDB_EXTERNAL_HOST_0="${MDB_RESOURCE_NAME}-0.${MDB_RESOURCE_NAME}-svc.${MDB_NS}.svc.cluster.local:27017"
export MDB_EXTERNAL_HOST_1="${MDB_RESOURCE_NAME}-1.${MDB_RESOURCE_NAME}-svc.${MDB_NS}.svc.cluster.local:27017"
export MDB_EXTERNAL_HOST_2="${MDB_RESOURCE_NAME}-2.${MDB_RESOURCE_NAME}-svc.${MDB_NS}.svc.cluster.local:27017"

# REPLACE with your external MongoDB keyfile secret name
export MDB_EXTERNAL_KEYFILE_SECRET_NAME="${MDB_RESOURCE_NAME}-keyfile"

# REPLACE with the actual keyfile content from your external MongoDB replica set
# For testing, this will be automatically generated by the MongoDB Enterprise resource
export MDB_EXTERNAL_KEYFILE_CONTENT="your-mongodb-keyfile-content-CHANGE-ME"

# REPLACE with your actual external MongoDB replica set name
export MDB_EXTERNAL_REPLICA_SET_NAME="${MDB_RESOURCE_NAME}"

export OPERATOR_HELM_CHART="mongodb/mongodb-kubernetes"
export OPERATOR_ADDITIONAL_HELM_VALUES=""

export MDB_CONNECTION_STRING="mongodb://mdb-user:${MDB_USER_PASSWORD}@${MDB_EXTERNAL_HOST_0}/?replicaSet=${MDB_EXTERNAL_REPLICA_SET_NAME}"
```

This will load the variables into your current shell session, making them available for the commands in the following
steps.

### 2. Create Ops Manager Resources

Before deploying MongoDB Enterprise, you need to create the Ops Manager configuration and credentials. This step creates
a ConfigMap with your Ops Manager project details and a Secret with your API credentials.

[code_snippets/04_0050_create_ops_manager_resources.sh](code_snippets/04_0050_create_ops_manager_resources.sh)

```shell copy
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" create configmap om-project \
  --from-literal=projectName="${OPS_MANAGER_PROJECT_NAME}" --from-literal=baseUrl="${OPS_MANAGER_API_URL}" \
  --from-literal=orgId="${OPS_MANAGER_ORG_ID:-}"

kubectl --context "${K8S_CTX}" -n "${MDB_NS}" create secret generic om-credentials \
  --from-literal=publicKey="${OPS_MANAGER_API_USER}" \
  --from-literal=privateKey="${OPS_MANAGER_API_KEY}"
```

### 3. Add MongoDB Helm Repository

Add the MongoDB Helm repository. This repository contains the Helm chart required to install the MongoDB
Kubernetes Operator. The operator automates the deployment and management of MongoDB Search instances on Kubernetes.

[code_snippets/04_0090_helm_add_mogodb_repo.sh](code_snippets/04_0090_helm_add_mogodb_repo.sh)

```shell copy
helm repo add mongodb https://mongodb.github.io/helm-charts
helm repo update mongodb
helm search repo mongodb/mongodb-kubernetes
```

### 4. Install MongoDB Kubernetes Operator

Install the MongoDB Kubernetes Operator from the Helm repository you just added. The Operator will watch for
MongoDBSearch custom resources and manage the lifecycle of your MongoDB Search deployments.

[code_snippets/04_0100_install_operator.sh](code_snippets/04_0100_install_operator.sh)

```shell copy
helm upgrade --install --debug --kube-context "${K8S_CTX}" \
  --create-namespace \
  --namespace="${MDB_NS}" \
  mongodb-kubernetes \
  --set "${OPERATOR_ADDITIONAL_HELM_VALUES:-"dummy=value"}" \
  "${OPERATOR_HELM_CHART}"
```

This command installs the operator in the `mongodb` namespace (creating it if it doesn't exist).

## Deploying MongoDB Search

With the prerequisites and initial setup complete, you can now deploy MongoDB Search to connect to your external MongoDB
Enterprise.

### 5. Create MongoDB Enterprise Users

MongoDB Search requires authentication credentials to connect to your external MongoDB Enterprise, and you'll also need
credentials for testing the search functionality. This step creates MongoDB Enterprise user resources that will be
managed by Ops Manager.

[code_snippets/04_0305_create_mongodb_enterprise_users.sh](code_snippets/04_0305_create_mongodb_enterprise_users.sh)

```shell copy
# admin user with root role
kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic mdb-admin-user-password \
  --from-literal=password="${MDB_ADMIN_USER_PASSWORD}"

kubectl apply --context "${K8S_CTX}" -n "${MDB_NS}" -f - <<EOF
apiVersion: mongodb.com/v1
kind: MongoDBUser
metadata:
  name: mdb-admin
spec:
  username: mdb-admin
  db: admin
  mongodbResourceRef:
    name: ${MDB_RESOURCE_NAME}
  passwordSecretKeyRef:
    name: mdb-admin-user-password
    key: password
  roles:
  - name: root
    db: admin
EOF

# user used by MongoDB Search to connect to MongoDB database to synchronize data from
kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic ${MDB_RESOURCE_NAME}-search-sync-source-password \
  --from-literal=password="${MDB_SEARCH_SYNC_USER_PASSWORD}"
kubectl apply --context "${K8S_CTX}" -n "${MDB_NS}" -f - <<EOF
apiVersion: mongodb.com/v1
kind: MongoDBUser
metadata:
  name: search-sync-source-user
spec:
  username: search-sync-source
  db: admin
  mongodbResourceRef:
    name: ${MDB_RESOURCE_NAME}
  passwordSecretKeyRef:
    name: ${MDB_RESOURCE_NAME}-search-sync-source-password
    key: password
  roles:
  - name: searchCoordinator
    db: admin
EOF

# user performing search queries
kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic mdb-user-password \
  --from-literal=password="${MDB_USER_PASSWORD}"
kubectl apply --context "${K8S_CTX}" -n "${MDB_NS}" -f - <<EOF
apiVersion: mongodb.com/v1
kind: MongoDBUser
metadata:
  name: mdb-user
spec:
  username: mdb-user
  db: admin
  mongodbResourceRef:
    name: ${MDB_RESOURCE_NAME}
  passwordSecretKeyRef:
    name: mdb-user-password
    key: password
  roles:
  - name: readWrite
    db: sample_mflix
EOF
```

This creates MongoDB Enterprise user resources that will be managed by Ops Manager, including the search synchronization
user with the searchCoordinator role.

### 6. Create External MongoDB Keyfile Secret

Your external MongoDB replica set uses a keyfile for internal authentication between replica set members. MongoDB Search
needs access to this same keyfile to authenticate with your external MongoDB. This step creates a Kubernetes secret
containing the keyfile content from your external MongoDB.

**Important**: You must obtain the keyfile content from your external MongoDB replica set. This is typically a
base64-encoded string or the raw keyfile content used by your MongoDB instances.

[code_snippets/04_0318_create_external_keyfile_secret.sh](code_snippets/04_0318_create_external_keyfile_secret.sh)

```shell copy
kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic "${MDB_EXTERNAL_KEYFILE_SECRET_NAME}" \
  --from-literal=keyfile="${MDB_EXTERNAL_KEYFILE_CONTENT}"
```

**Note**: Make sure to set the `MDB_EXTERNAL_KEYFILE_CONTENT` environment variable to the exact keyfile content used by
your external MongoDB replica set.

### 7. Create MongoDB Search Resource

Deploy a `MongoDBSearch` resource named `mdbs` that connects to your external MongoDB Enterprise replica set. The Search
resource lists the external replica set members under `spec.source.external.hostAndPorts` and uses the search
synchronization user credentials. TLS is disabled in this example.

[code_snippets/04_0320_create_mongodb_search_resource.sh](code_snippets/04_0320_create_mongodb_search_resource.sh)

```shell copy
kubectl apply --context "${K8S_CTX}" -n "${MDB_NS}" -f - <<EOF
apiVersion: mongodb.com/v1
kind: MongoDBSearch
metadata:
  name: mdbs
spec:
  source:
    external:
      hostAndPorts:
        - ${MDB_EXTERNAL_HOST_0}
        - ${MDB_EXTERNAL_HOST_1}
        - ${MDB_EXTERNAL_HOST_2}
      keyFileSecretRef:
        name: ${MDB_EXTERNAL_KEYFILE_SECRET_NAME}
        key: keyfile
      tls:
        enabled: false
    username: search-sync-source
    passwordSecretRef:
      name: ${MDB_RESOURCE_NAME}-search-sync-source-password
      key: password
  resourceRequirements:
    limits:
      cpu: "3"
      memory: 5Gi
    requests:
      cpu: "2"
      memory: 3Gi
EOF
```

The `MongoDBSearch.spec` fields in this example are:

* `spec.source.external.hostAndPorts` - list of external MongoDB replica set members.
* `spec.source.external.keyFileSecretRef` - reference to the keyfile secret used by the external replica set.
* `spec.source.external.tls.enabled` - set to `false` to disable TLS between mongot and mongod.
* `spec.username` and `spec.passwordSecretRef` - credentials for the search synchronization user in the external
  MongoDB.
* `spec.resourceRequirements` - resource requests and limits for the search container.

### 8. Create LoadBalancer Service for External Search Access

To enable your external MongoDB instances to connect to the search service, create a LoadBalancer service that exposes
the search pods outside the Kubernetes cluster.

[code_snippets/04_0322_create_search_loadbalancer_service.sh](code_snippets/04_0322_create_search_loadbalancer_service.sh)

```shell copy
kubectl apply --context "${K8S_CTX}" -n "${MDB_NS}" -f - <<YAML
apiVersion: v1
kind: Service
metadata:
  name: ${MDB_SEARCH_HOSTNAME}
spec:
  type: LoadBalancer
  selector:
    app: mdbs-search-svc
  ports:
    - name: mongot
      port: 27027
      targetPort: 27027
YAML

# Wait for LoadBalancer to get an external IP/hostname
echo "Waiting for LoadBalancer to get an external IP..."
for i in {1..60}; do
  SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
  if [ -z "${SEARCH_IP}" ]; then
    SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
  fi

  if [ -n "${SEARCH_IP}" ]; then
    echo "LoadBalancer external address: ${SEARCH_IP}"
    break
  fi

  echo "Attempt ${i}/60: Waiting for external IP/hostname..."
  sleep 5
done

if [ -z "${SEARCH_IP}" ]; then
  echo "Error: LoadBalancer failed to get an external IP/hostname after 5 minutes"
  exit 1
fi
```

### 9. Update CoreDNS Configuration for External Access

When using external MongoDB instances, you need to configure DNS resolution so that the external MongoDB can resolve the
search service hostname.

[code_snippets/04_0323_update_coredns_configmap.sh](code_snippets/04_0323_update_coredns_configmap.sh)

```shell copy
# Fetch the LoadBalancer external IP/hostname
SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
if [ -z "${SEARCH_IP}" ]; then
  SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
fi

if [ -z "${SEARCH_IP}" ]; then
  echo "Error: Could not get LoadBalancer external IP/hostname for service ${MDB_SEARCH_HOSTNAME}"
  exit 1
fi

echo "Using LoadBalancer external address: ${SEARCH_IP}"

kubectl --context "${K8S_CTX}" -n kube-system apply -f - <<YAML
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
data:
  Corefile: |
    .:53 {
        errors
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
        hosts {
           ${SEARCH_IP} ${MDB_SEARCH_HOSTNAME}
           fallthrough
        }
    }
YAML

kubectl --context "${K8S_CTX}" -n kube-system rollout restart deployment coredns
```

### 10. Wait for Search Resource to be Ready
external IP address.
The Search deployment needs time to initialize. This step uses `kubectl wait` to pause until the `MongoDBSearch`
resource `mdbs` reports a `Running` status.
### 9. Wait for Search Resource to be Ready

[code_snippets/04_0325_wait_for_search_resource.sh](code_snippets/04_0325_wait_for_search_resource.sh)
[code_snippets/0325_wait_for_search_resource.sh](code_snippets/0325_wait_for_search_resource.sh)

```shell copy
echo "Waiting for MongoDBSearch resource to reach Running phase..."
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" wait \
  --for=jsonpath='{.status.phase}'=Running mdbs/mdbs --timeout=300s
```

### 11. List Running Search Pods
This command polls the status of the `MongoDBSearch` resource `mdbs`.
View the running search pods in your namespace. You should see pods for the MongoDB Kubernetes Operator and the MongoDB
Search nodes.
### 10. List Running Search Pods

[code_snippets/04_0335_show_running_pods.sh](code_snippets/04_0335_show_running_pods.sh)
[code_snippets/0335_show_running_pods.sh](code_snippets/0335_show_running_pods.sh)

```shell copy
echo; echo "MongoDBSearch resource"
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get mdbs/mdbs
echo; echo "Search pods running in cluster ${K8S_CTX}"
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get pods -l app=mdbs-search-svc
echo; echo "All pods in namespace ${MDB_NS}"
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get pods
```

## Cleanup
allowing you to use `kubectl exec` to run MongoDB client tools like `mongosh` and `mongorestore`.
To clean up the resources created by this guide:
[code_snippets/0410_run_mongodb_tools_pod.sh](code_snippets/0410_run_mongodb_tools_pod.sh)
[code_snippets/04_9010_delete_namespace.sh](code_snippets/04_9010_delete_namespace.sh)
[code_snippets/0420_import_movies_mflix_database.sh](code_snippets/0420_import_movies_mflix_database.sh)

kubectl --context "${K8S_CTX}" delete namespace "${MDB_NS}"
    --eval 'db.movies.createSearchIndex("default", { mappings: { dynamic: true } });'
)"
```
